var CmfFileUploads={baseUploaderOptions:{language:$(document.body).attr("data-locale"),validateInitialCount:!0,showUpload:!1,allowedFileTypes:["image","text","video","audio","object"],allowedPreviewTypes:["image","video","audio"],previewFileType:"any",previewFileIcon:'<i class="fa fa-file"></i>',initialPreviewAsData:!0,overwriteInitial:!0,fileActionSettings:{showDrag:!1,showDownload:!0},browseIcon:'<i class="glyphicon glyphicon-picture"></i>',layoutTemplates:{main1:"{preview}\n<div class='input-group {class}'>\n   <div class='input-group-btn'>\n       {browse}\n       {upload}\n       {remove}\n   </div>\n   {caption}\n</div>"}},imageUploaderOptions:{allowedFileTypes:["image"],allowedPreviewTypes:["image"],previewFileType:"image",initialPreviewFileType:"image"},fileUploaderOptions:{fileActionSettings:{showDrag:!1,showDownload:!0,showBrowse:!1},initialPreviewFileType:"object",previewFileIconSettings:{doc:'<i class="fa fa-file-word-o text-primary"></i>',docx:'<i class="fa fa-file-word-o text-primary"></i>',txt:'<i class="fa fa-file-text-o"></i>',json:'<i class="fa fa-file-text-o"></i>',js:'<i class="fa fa-file-text-o"></i>',rtf:'<i class="fa fa-file-text-o"></i>',xls:'<i class="fa fa-file-excel-o text-success"></i>',xlsx:'<i class="fa fa-file-excel-o text-success"></i>',csv:'<i class="fa fa-file-excel-o text-success"></i>',ppt:'<i class="fa fa-file-powerpoint-o text-danger"></i>',pptx:'<i class="fa fa-file-powerpoint-o text-danger"></i>',pdf:'<i class="fa fa-file-pdf-o text-danger"></i>',zip:'<i class="fa fa-file-archive-o text-muted"></i>',gzip:'<i class="fa fa-file-archive-o text-muted"></i>',rar:'<i class="fa fa-file-archive-o text-muted"></i>'}}};CmfFileUploads.initFileUploaders=function(e,t,a){for(var n in e.configs)CmfFileUploads.initFileUploader(e,n,t,a)},CmfFileUploads.initFileUploader=function(e,t,a,n){var r=e.configs[t],i=1===r.max_files_count;r.defaultPluginOptions=$.extend({layoutTemplates:{}},CmfFileUploads.baseUploaderOptions,a?CmfFileUploads.imageUploaderOptions:CmfFileUploads.fileUploaderOptions,$.isPlainObject(n)?n:{},{allowedFileExtensions:r.allowed_extensions,minFileCount:0,maxFileCount:1,maxFileSize:r.max_file_size,showCaption:i,previewClass:i?"single-file-upload":"multi-file-upload"}),i||(r.defaultPluginOptions.layoutTemplates.main2='<button class="fileinput-dragger" type="button"><span class="fa fa-arrows"></span></button>{preview}\n<div class="kv-upload-progress kv-hidden"></div>\n<div class="clearfix"></div>\n<div class="kv-upload-toolbar text-center">{remove}\n{cancel}\n{upload}\n{browse}\n</div>',r.defaultPluginOptions.layoutTemplates.preview='<div class="file-preview {class}">\n    {close}    <div class="no-file">'+CmfConfig.getLocalizationStringsForComponent("file_uploader").no_file+'</div>    <div class="{dropClass}">\n    <div class="file-preview-thumbnails">\n    </div>\n    <div class="clearfix"></div>    <div class="file-preview-status text-center text-success"></div>\n    <div class="kv-fileinput-error"></div>\n    </div>\n</div>'),r.inputsAdded=0,r.isCloning=!!e.is_cloning,r.isInModal=!!e.is_in_modal,Utils.makeTemplateFromText($("#"+r.id+"-tpl").html(),"CmfFileUploads.initFileUploader for files group "+t).done(function(a){if(r.inputTpl=a,r.addInput=function(e,t){return CmfFileUploads.initFileUploaderInput(r,e,t)},$("#"+r.id+"-add").on("click",function(){return r.addInput(),r.inputsAdded>=r.max_files_count&&$(this).remove(),!1}),e.files&&$.isPlainObject(e.files)&&e.files.urls&&e.files.urls[t]&&e.files.preview_info&&e.files.preview_info[t]&&e.files.files&&e.files.files[t]){var n=e.files.urls[t],o=e.files.preview_info[t],l=e.files.files[t];if($.isArray(n)&&$.isArray(o)&&$.isArray(l))for(var s=0;s<n.length;s++)r.addInput({initialPreview:[n[s]],initialPreviewConfig:[o[s]],initialCaption:[o[s].caption]},$.extend({is_cloning:r.isCloning},l[s]))}0===r.inputsAdded&&(i||r.min_files_count>0)&&r.addInput();for(var d=r.inputsAdded;d<r.min_files_count;d++)r.addInput();if(!i){var c=$("#"+r.id+"-container");c.data("sortable",Sortable.create(c[0],{handle:".fileinput-dragger",draggable:".file-upload-input-container",animation:200,forceFallback:!0,onUpdate:function(e){$(e.to).find(".file-upload-input-container").each(function(e,t){$(t).find('input[name$="][position]"]').val(String(e+1)),$(t).find("input[name]").each(function(t,a){a.name=String(a.name).replace(/\]\[[0-9]\]\[/,"]["+String(e)+"][")})})}}))}})},CmfFileUploads.initFileUploaderInput=function(e,t,a){if(e.inputsAdded>=e.max_files_count)return!1;$.isPlainObject(a)||(a={}),a=$.extend({index:e.inputsAdded},a);var n=$(e.inputTpl(a));$("#"+e.id+"-container").append(n),e.inputsAdded++;var r=n.find('input[type="file"]'),i=$.extend({},e.defaultPluginOptions,$.isPlainObject(t)?t:{});if(a.is_cloning&&a.url){var o=new XMLHttpRequest;o.onload=function(){var e=new FileReader;e.onloadend=function(){$("#"+r[0].id+"-file-data").val(JSON.stringify($.extend({data:e.result},a)))},e.readAsDataURL(o.response)},o.open("GET",a.url),o.responseType="blob",o.send()}r.fileinput(i).on("fileclear",function(){$("#"+this.id+"-deleted").val("1"),$("#"+this.id+"-file-data").remove();var t=$("#"+e.id+"-container").data("sortable");if(t){var a=t.toArray(),n=$.inArray(this.id,a);n>=0&&(a.splice(n,1),a.push(this.id),t.sort(a))}}).on("change",function(){$("#"+this.id+"-file-data").remove()}).on("filezoomhidden",function(t,a){a.modal.remove(),e.isInModal&&($("body").addClass("modal-open"),$(".modal.in").css("padding-left","17px"))})},function(e){"use strict";function t(e){t.start(e)}function a(){if(!h)throw new Error("Attempt to navigate before router is started")}function n(e){return window.location.pathname+window.location.search+(e?window.location.hash:"")}function r(e,t){!1!==t?e.dispatch():e.pushState()}function i(e){return"string"!=typeof e?e:w?decodeURIComponent(e.replace(/\+/g," ")):e}function o(e){var t=n(!0);t!==e.originalPath&&t!==e.fullUrl()&&(document.location=e.originalPath)}function l(e,t,a){x++;var n=x;this.id=function(){return n},this.originalPath=e,0===e.indexOf("http")&&u(e)&&(e=e.replace(/https?:\/\/.+?\//,"/")),"/"===e[0]&&0!==e.indexOf(S)&&(e=S+e);var r=e.indexOf("?");if(this.title=document.title,this.state=t||{},this.querystring=~r?i(e.slice(r+1)):"",this.pathname=i(~r?e.slice(0,r):e),this.path=this.pathname.replace(S,"")||"/",this.params={},this.customData=a&&"object"==typeof a?a:{},this.customData.env&&"object"==typeof this.customData.env||(this.customData.env={}),this.promise=null,this.routeFound=!1,this.routeNotFoundHandled=!1,this.error=!1,this.errorHandled=!1,this.parentRequest=null,this.subRequest=null,this.hash="",~this.originalPath.indexOf("#")){var o=this.originalPath.split("#");this.hash=i(o[1])||"",this.querystring=this.querystring.split("#",2)[0],this.path=this.path.split("#",2)[0],this.pathname=this.pathname.split("#",2)[0],"!"===this.hash[0]&&(this.subRequest=new l(this.hash.slice(1)),this.subRequest.parentRequest=this,this.hash="")}y&&(this.query=p(this.querystring))}function s(e,t){t=t||{},this.isWildcard="*"===e,this.path=this.isWildcard?"(.*)":e,this.method="GET",this.regexp=f(this.path,this.keys=[],t)}function d(e){if(1===c(e)&&!(e.metaKey||e.ctrlKey||e.shiftKey||e.defaultPrevented)){for(var a=e.path?e.path[0]:e.target;a&&"A"!==a.nodeName;)a=a.parentNode;if(a&&"A"===a.nodeName&&!a.hasAttribute("download")&&"external"!==a.getAttribute("rel")){var n=a.getAttribute("href");if((a.pathname!==window.location.pathname||!a.hash&&"#"!==n)&&!(n&&n.indexOf("mailto:")>-1)&&!a.target&&u(a.href)){var r=a.pathname+a.search+(a.hash||""),i=r;0===r.indexOf(S)&&(r=r.substr(S.length)),S&&i===r||(e.preventDefault(),t.show(i,void 0,!0,!0,{env:{is_click:!0,target:this.activeElement||e.target}}))}}}}function c(e){return e=e||window.event,null===e.which?e.button:e.which}function u(e){var t=window.location.protocol+"//"+window.location.hostname;return window.location.port&&(t+=":"+window.location.port),e&&0===e.indexOf(t)}function f(e,t,a){function n(e){for(var t,a=[],n=0,r=0,i="";null!==(t=u.exec(e));){var o=t[0],s=t[1],d=t.index;if(i+=e.slice(r,d),r=d+o.length,s)i+=s[1];else{i&&(a.push(i),i="");var c=t[2],f=t[3],p=t[4],m=t[5],h=t[6],g=t[7],v="+"===h||"*"===h,b="?"===h||"*"===h,C=c||"/",w=p||m||(g?".*":"[^"+C+"]+?");a.push({name:f||n++,prefix:c||"",delimiter:C,optional:b,repeat:v,pattern:l(w)})}}return r<e.length&&(i+=e.substr(r)),i&&a.push(i),a}function r(e){return i(n(e))}function i(e){for(var t=new Array(e.length),a=0;a<e.length;a++)"object"==typeof e[a]&&(t[a]=new RegExp("^"+e[a].pattern+"$"));return function(a){for(var n="",r=a||{},i=0;i<e.length;i++){var o=e[i];if("string"!=typeof o){var l,s=r[o.name];if(null===s){if(o.optional)continue;throw new TypeError('Expected "'+o.name+'" to be defined')}if(b(s)){if(!o.repeat)throw new TypeError('Expected "'+o.name+'" to not repeat, but received "'+s+'"');if(0===s.length){if(o.optional)continue;throw new TypeError('Expected "'+o.name+'" to not be empty')}for(var d=0;d<s.length;d++){if(l=encodeURIComponent(s[d]),!t[i].test(l))throw new TypeError('Expected all "'+o.name+'" to match "'+o.pattern+'", but received "'+l+'"');n+=(0===d?o.prefix:o.delimiter)+l}}else{if(l=encodeURIComponent(s),!t[i].test(l))throw new TypeError('Expected "'+o.name+'" to match "'+o.pattern+'", but received "'+l+'"');n+=o.prefix+l}}else n+=o}return n}}function o(e){return e.replace(/([.+*?=^!:${}()[\]|\/])/g,"\\$1")}function l(e){return e.replace(/([=!:$\/()])/g,"\\$1")}function s(e,t){return e.keys=t,e}function d(e){return e.sensitive?"":"i"}function c(e,t){t=t||{};for(var a=t.strict,n=!1!==t.end,r="",i=e[e.length-1],l="string"==typeof i&&/\/$/.test(i),s=0;s<e.length;s++){var c=e[s];if("string"==typeof c)r+=o(c);else{var u=o(c.prefix),f=c.pattern;c.repeat&&(f+="(?:"+u+f+")*"),f=c.optional?u?"(?:"+u+"("+f+"))?":"("+f+")?":u+"("+f+")",r+=f}}return a||(r=(l?r.slice(0,-2):r)+"(?:\\/(?=$))?"),r+=n?"$":a&&l?"":"(?=\\/|$)",new RegExp("^"+r,d(t))}f.compile=r;var u=new RegExp(["(\\\\.)","([\\/.])?(?:(?:\\:(\\w+)(?:\\(((?:\\\\.|[^()])+)\\))?|\\(((?:\\\\.|[^()])+)\\))([+*?])?|(\\*))"].join("|"),"g");return t=t||[],b(t)?a||(a={}):(a=t,t=[]),e instanceof RegExp?function(e,t){var a=e.source.match(/\((?!\?)/g);if(a)for(var n=0;n<a.length;n++)t.push({name:n,prefix:null,delimiter:null,optional:!1,repeat:!1,pattern:null});return s(e,t)}(e,t):b(e)?function(e,t,a){for(var n=[],r=0;r<e.length;r++)n.push(convertPathToRegexp(e[r],t,a).source);return s(new RegExp("(?:"+n.join("|")+")",d(a)),t)}(e,t,a):function(e,t,a){for(var r=n(e),i=c(r,a),o=0;o<r.length;o++)"string"!=typeof r[o]&&t.push(r[o]);return s(i,t)}(e,t,a)}function p(e){function t(e,t){if(0===e[t].length)return e[t]={};var a={};for(var n in e[t])a[n]=e[t][n];return e[t]=a,a}function a(e,n,r,i){var o=e.shift();if(o){var l=n[r]=n[r]||[];"]"===o?b(l)?""!==i&&l.push(i):"object"==typeof l?l[Object.keys(l).length]=i:n[r]=[n[r],i]:~o.indexOf("]")?(o=o.substr(0,o.length-1),!u.test(o)&&b(l)&&(l=t(n,r)),a(e,l,o,i)):(!u.test(o)&&b(l)&&(l=t(n,r)),a(e,l,o,i))}else b(n[r])?n[r].push(i):"object"==typeof n[r]?n[r]=i:void 0===n[r]?n[r]=i:n[r]=[n[r],i]}function n(e,t,n){if(~t.indexOf("]"))a(t.split("["),e,"base",n);else{if(!u.test(t)&&b(e.base)){var r={};for(var i in e.base)r[i]=e.base[i];e.base=r}s(e.base,t,n)}return e}function r(e,t){return b(e)?o(e,t):"[object Object]"===c.call(e)?l(e,t):"string"==typeof e?i(e,t):t+"="+e}function i(e,t){if(!t)throw new TypeError("stringify expects an object");return t+"="+encodeURIComponent(e)}function o(e,t){var a=[];if(!t)throw new TypeError("stringify expects an object");for(var n=0;n<e.length;n++)a.push(r(e[n],t+"["+n+"]"));return a.join("&")}function l(e,t){for(var a,n=[],i=Object.keys(e),o=0,l=i.length;o<l;++o)a=i[o],n.push(r(e[a],t?t+"["+encodeURIComponent(a)+"]":encodeURIComponent(a)));return n.join("&")}function s(e,t,a){var n=e[t];void 0===n?e[t]=a:b(n)?n.push(a):e[t]=[n,a]}function d(e){for(var t,a,n=e.length,r=0;r<n;++r)if(a=e[r],"]"===a&&(t=!1),"["===a&&(t=!0),"="===a&&!t)return r}p.stringify=r;var c=Object.prototype.toString,u=/^[0-9]+$/;return null===e||""===e?{}:"object"==typeof e?function(e){var t={base:{}};return Object.keys(e).forEach(function(a){n(t,a,e[a])}),t.base}(e):function(e){var t={base:{}};return String(e).split("&").reduce(function(e,t){try{t=decodeURIComponent(t.replace(/\+/g," "))}catch(e){}var a=t.indexOf("="),r=d(t),i=t.substr(0,r||a),o=t.substr(r||a,t.length);return o=o.substr(o.indexOf("=")+1,o.length),""===i&&(i=t,o=""),n(e,i,o)},t),t.base}(e)}function m(e){var t="pending",a=[],n=[],r=[],i=null,o={done:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(b(arguments[e]))for(var n=arguments[e],r=0;r<n.length;r++)"resolved"===t&&n[r].apply(this,i),a.push(n[r]);else"resolved"===t&&arguments[e].apply(this,i),a.push(arguments[e]);return this},fail:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(b(arguments[e]))for(var a=arguments[e],r=0;r<a.length;r++)"rejected"===t&&a[r].apply(this,i),n.push(a[r]);else"rejected"===t&&arguments[e].apply(this,i),n.push(arguments[e]);return this},always:function(){return this.done.apply(this,arguments).fail.apply(this,arguments)},progress:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(b(arguments[e]))for(var a=arguments[e],n=0;n<a.length;n++)"pending"===t&&r.push(a[n]);else"pending"===t&&r.push(arguments[e]);return this},then:function(){arguments.length>1&&arguments[1]&&this.fail(arguments[1]),arguments.length>0&&arguments[0]&&this.done(arguments[0]),arguments.length>2&&arguments[2]&&this.progress(arguments[2])},promise:function(e){if(e){for(var t in o)e[t]=o[t];return e}return o},state:function(){return t},debug:function(){console.log("[debug]",a,n,t)},isRejected:function(){return"rejected"===t},isResolved:function(){return"resolved"===t}},l={resolveWith:function(e,n){if("pending"===t){t="resolved",i=C(n);for(var r=0;r<a.length;r++)a[r].apply(e,i)}return this},rejectWith:function(e,a){if("pending"===t){t="rejected",i=C(a);for(var r=0;r<n.length;r++)n[r].apply(e,i)}return this},notifyWith:function(e,a){if("pending"===t){i=C(a);for(var n=0;n<r.length;n++)r[n].apply(e,i)}return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},notify:function(){return this.notifyWith(this,arguments)}},s=o.promise(l);return"function"==typeof e&&e.apply(s,[s]),s}e.page=t,t.isSameOrigin=u,t.Request=l,t.Route=s,t.pathToRegexp=f,t.queryString=p,t.Deferred=m;var h,g,v="undefined"!=typeof document&&document.ontouchstart?"touchstart":"click",b=("undefined"!=typeof window&&(window.history.location||window.location),b||function(e){return"[object Array]"===Object.prototype.toString.call(e)}),C=function(e){return e?"object"==typeof e&&e.length?b(e)?e:1===e.length?[e[0]]:Array.apply(null,e):[e]:[]},w=!0,y=!1,S="",_={promise:m().resolve().promise()},x=0,U=0,T=[],D=[],R=[],k=[];t.currentRequest=function(){return _},t.currentUrlWithoutBase=function(){return t.currentRequest().path},t.currentUrl=function(){return t.currentRequest().fullUrl(!0)},t.previousRequest=function(){return g},t.previousUrlWithoutBase=function(){return t.previousRequest().path},t.previousUrl=function(){return t.previousRequest().fullUrl(!0)},t.base=function(e){if(0===arguments.length)return S;S=e},t.start=function(e){e=e||{},h||(h=!0,U=0,!1===e.decodeURLComponents&&(w=!1),e.decodeURLQuery&&(y=!0),!1!==e.popstate&&window.addEventListener("popstate",I,!1),!1!==e.click&&document.addEventListener(v,d,!1),t.show(n(!0),void 0,!1!==e.dispatch,!0,{env:{is_first:!0}}))},t.stop=function(){h&&(_=null,g=null,h=!1,document.removeEventListener(v,d,!1),window.removeEventListener("popstate",I,!1))},t.route=function(e,t,a,n){if("string"!=typeof e)throw new TypeError("1st argument passed to page.route() must be a string. Use '*' if you want to apply callbacks to all routes");for(var r=new s(e),i=1;i<arguments.length;i++){if("function"!=typeof arguments[i])throw new TypeError("argument "+(i+1)+" passed to page.route() for route "+e+" is not a funciton");T.push(r.middleware(arguments[i],"route_handler"))}},t.error=function(e,a){if("function"==typeof e)return t.exit("*",e);if("function"!=typeof a)throw new TypeError("2nd argument must be a function");for(var n=new s(e),r=1;r<arguments.length;r++)R.push(n.middleware(arguments[r],"error_handler"))},t.notFound=function(e,a){if("function"==typeof e)return t.exit("*",e);if("function"!=typeof a)throw new TypeError("2nd argument must be a function");for(var n=new s(e),r=1;r<arguments.length;r++)k.push(n.middleware(arguments[r],"page_not_found_handler"))},t.exit=function(e,a){if("function"==typeof e)return t.exit("*",e);if("function"!=typeof a)throw new TypeError("2nd argument must be a function");for(var n=new s(e),r=1;r<arguments.length;++r)D.push(n.middleware(arguments[r],"exit"))},t.show=function(e,t,n,i,o){a();var s=new l(e,t,o);return r(s,n),s},t.back=function(e,n){a(),U>1&&window.history.length>0?_.promise.always(function(){U--,window.history.back()}):e?t.show(e,n,!0,!0):t.show(S,n,!0,!0)},t.reload=function(){if(a(),!_||!_.path)throw new Error("Attempt to reload page before router has dispatched at least one page");t.show(document.location.href,void 0,!0,!0,{env:{is_reload:!0}})},t.replace=function(e,t,a,n){var r=new l(e,t,n);return _.promise.always(function(){r.saveState()}),!1!==a&&r.dispatch(),r},t.restoreRequest=function(e,t){e.customData&&(e.customData.env={}),e.customData.env.is_restore=!0,r(e,t)},l.prototype.reload=function(){t.show(_.fullUrl(),_.state,!0,!0,{env:{is_reload:!0}})},l.prototype.hasSamePathAs=function(e){return"object"==typeof e&&this.path===e.path&&this.querystring===e.querystring},l.prototype.fullUrl=function(e){if(this.isSubRequest())return this.parentRequest.fullUrl();var t=S+this.path;return this.querystring.length>0&&(t+="?"+this.querystring),!1!==e&&(this.hasSubRequest()?t+="#!"+this.subRequest.makeUrlToUseItInParentRequest():this.hash.length>0&&(t+="#"+this.hash)),t},l.prototype.makeUrlToUseItInParentRequest=function(){var e=S+this.path;return this.querystring.length>0&&(e+="?"+this.querystring),e},l.prototype.id=function(){throw new Error("This method should never be called. Something wrong happened.")},l.prototype.isSameAs=function(e){return this.id()===e.id()},l.prototype.env=function(){return this.customData.env||{}},l.prototype.pushState=function(e){var t=this.fullUrl(!0);e||n(!0)!==t?(U++,history.pushState(this.state,this.title,t)):this.saveState()},l.prototype.saveState=function(){history.replaceState(this.state,this.title,this.fullUrl(!0))},l.prototype.convertToSubrequest=function(){_.isSameAs(this)?this.parentRequest=g:this.parentRequest=_,this.parentRequest.setSubRequest(this)},l.prototype.isSubRequest=function(){return!!this.parentRequest},l.prototype.hasSubRequest=function(){return!!this.subRequest},l.prototype.restoreParentRequest=function(e){this.isSubRequest()&&_.hasSubRequest()&&_.isSameAs(this.parentRequest)&&(this.parentRequest.removeSubRequest(),!1===e?this.parentRequest.pushState():(this.parentRequest.customData.env.is_restore=!0,this.parentRequest.dispatch()))},l.prototype.setSubRequest=function(e){this.subRequest=e,this.parentRequest=null,e.removeSubRequest()},l.prototype.removeSubRequest=function(){this.subRequest=null},l.prototype.dispatch=function(){var e=this,t=m(),a=_&&_.backup?_.backup():_,n=g&&g.backup?g.backup():g,r=_.promise;return e.promise=t.promise(),r.always(function(){g=_,_=e,m.queue(g&&g.path?D:[],g,[g,e]).done(function(){m.queue(T,e,[e]).done(function(){t.resolve()}).fail(function(){t.reject.apply(t,arguments)})}).fail(function(){t.reject.apply(t,arguments)}),e.promise.done(function(){if(e.routeFound)if(e.pushState(),delete e.customData.env.is_restore,e.hasSubRequest()){var t=g;setTimeout(function(){e.subRequest.dispatch().always(function(){g=t,_=e})},300)}else e.isSubRequest()&&(g=n,_=e.parentRequest);else m.queue(k,e,[e]).done(function(){e.routeNotFoundHandled||(o(e),e.routeNotFoundHandled=!0)})}).fail(function(t){m.queue(R,e,[e]).done(function(){e.errorHandled||(e.errorHandled=!0,console.error("Error occured while handling a request to "+e.originalPath),console.groupCollapsed("Error details"),console.warn("request",e),console.warn("request error",t),console.groupEnd())}).fail(function(){console.error("Error occured while handling a request and error"+e.originalPath),console.groupCollapsed("Error details"),console.warn("request",e),console.warn("request error",t),console.warn("error handler fail info:",arguments),console.groupEnd(),e.errorHandled=!0}).always(function(){_=a,g=n})})}),e.promise},l.prototype.clone=function(){return new l(this.fullUrl(),$.extend(!0,{},this.state),$.extend(!0,{},this.customData))},l.prototype.backup=function(){var e=this.clone();return e.promise=this.promise,e},s.prototype.middleware=function(e,t){var a=this;return function(n){var r=arguments;return m(function(i){if(a.match(n.path,n.params)){"route_handler"!==t||a.isWildcard?"route_not_found_handler"===t?n.routeNotFoundHandled=!0:"error_handler"===t&&(n.errorHandled=!0):n.routeFound=!0;try{var o=e.apply(n,r);"object"==typeof o&&"function"==typeof o.then?o.then(function(){i.resolve()},function(){i.reject.apply(i,arguments)}):i.resolve()}catch(e){i.reject(e)}}else i.resolve()})}},s.prototype.match=function(e,t){var a=this.keys,n=e.indexOf("?"),r=~n?e.slice(0,n):e,o=this.regexp.exec(decodeURIComponent(r));if(!o)return!1;for(var l=1,s=o.length;l<s;++l){var d=a[l-1],c=i(o[l]);void 0===c&&Object.prototype.hasOwnProperty.call(t,d.name)||(t[d.name]=c)}return!0};var I=function(){var e=!1;if("undefined"!=typeof window)return"complete"===document.readyState?e=!0:window.addEventListener("load",function(){setTimeout(function(){e=!0},0)}),function(a){e&&t.show(n(!0),a.state||null,!0,!1,{env:{is_history:!0}})}}();m.queue=function(e,t,a){var n=m();if(!e)return n.resolve();if(!b(e))throw new TypeError("Deferred.queue: argument 1 (functions) must be an array or empty");if(!e.length)return n.resolve();if(t){if("object"!=typeof t)throw new TypeError("Deferred.queue: argument 2 (context) must be an object or empty")}else t=n;if(a){if(!b(a))throw new TypeError("Deferred.queue: argument 3 (args) must be an array or empty")}else a=[];var r=0,i=[],o=function(){r<e.length?e[r++].apply(t,a).then(function(){i.push(C(arguments)),o()},function(){n.reject.apply(n,arguments)}):n.resolve.call(n,i)};return o(),n.promise()}}("undefined"!=typeof window?window:this);var CmfConfig={isDebug:!1,enablePing:!1,pingInterval:2e4,debugDialog:null,defaultPageTitle:"",pageTitleAddition:"",rootUrl:"/",scaffoldApiUrlSection:"api",uiUrl:null,userDataUrl:null,userDataCacheTimeoutMs:3e4,enableMenuCounters:!0,menuCountersDataUrl:null,menuCountersUpdateIntervalMs:3e4,disableMenuCountersIfEmptyOrInvalidDataReceived:!0,contentChangeAnimationDurationMs:300,contentWrapperCssClass:"section-content-wrapper",toastrOptions:{closeButton:!0,debug:!1,newestOnTop:!1,progressBar:!0,positionClass:"toast-top-right",preventDuplicates:!0,onclick:null,showDuration:"300",hideDuration:"500",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"slideDown",hideMethod:"slideUp"},setLocalizationStrings:function(e){CmfCache.localization=e},getLocalizationStringsForComponent:function(e){return e&&CmfCache.localization[e]?CmfCache.localization[e]:{}},getLocalizationString:function(e,t){if(!e||"string"!=typeof e)return"Invalid localization path. String expected.";for(var a=e.split("."),n=CmfCache.localization,r=0;r<a.length;r++){if(!$.isPlainObject(n)||!n.hasOwnProperty(a[r]))return t||e;n=n[a[r]]}return n}};CmfConfig.getDebugDialog=function(){return null===CmfConfig.debugDialog&&(CmfConfig.isDebug&&"function"==typeof DebugDialog?CmfConfig.debugDialog=new DebugDialog:CmfConfig.debugDialog={showDebug:function(e,t){toastr.error(e)},toggleVisibility:function(){}}),CmfConfig.debugDialog};var CmfCache={localization:{},views:{},user:null,userLastUpdateMs:0},DebugDialog=function(){function e(e,t){if(t||(t=""),!$.isPlainObject(t)&&t.length>3&&"{"===t[0]&&"}"===t[t.length-1])try{t=JSON.parse(t)}catch(e){}"string"!=typeof t?t='<html><head></head><body><pre style="white-space: pre-wrap;">'+JSON.stringify(t,null,3).replace(/\\\\/g,"\\").replace(/\\["']/g,'"').replace(/\\n/g,"\n")+"</pre></body></html>":t.match(/^\s*<(html|!doctype)/i)||(t=t.replace(/^([\s\S]*?)((?:<!doctype[^>]*>)?\s*<html[\s\S]*?<body[^>]*>)/i,"$2$1",t)),$.extend(n,{isVisible:!0,title:e,content:t}),a()}function t(e){n.isVisible=!n.isVisible,a()}function a(){if(n.isVisible){var e=$(i);r.empty().append(e.find(".dialog-title").html(n.title).end()),$.contains(document.body,r[0])||$(document.body).append(r);var t=r.find("iframe")[0];t&&t.contentWindow&&(t.contentWindow.document.open(),t.contentWindow.document.write(n.content),t.contentWindow.document.close())}else r.empty();return this}var n={title:"no title",content:"no content",isVisible:!1},r=$('<div id="debug-dialog"></div>'),i='<div class="dialog opened"><div class="dialog-close">&#x2716;</div><div class="dialog-title"></div><div class="dialog-content"><iframe frameborder="0"></iframe></div>';this.showDebug=e,this.toggleVisibility=t,r.on("click",".dialog-close",t)},FormHelper={messageAnimDurationMs:200};FormHelper.initInputPlugins=function(e){var t=e;t.find(".selectpicker").each(function(){var e=$(this),t=e.val();null!==t&&void 0!==t||null!==(t=e.find("option[selected]").first().val())&&void 0!==t||!e.prop("required")&&0!==e.find('option[value=""]').length||(t=e.find("option:first").val());var a={};e.find("option").length>10&&(a.liveSearch=!0,a.liveSearchNormalize=!0),e.attr("data-style")||(e.hasClass("input-sm")&&(a.style="input-sm"),e.hasClass("input-lg")&&(a.style="input-lg")),e.attr("data-abs-ajax-url")||e.attr("data-abs-ajax")?(a.liveSearch=!0,e.selectpicker(a).ajaxSelectPicker({ajax:{data:{keywords:"{{{q}}}"}}})):e.selectpicker(a),e.selectpicker("val",t)}),t.find('input.switch[type="checkbox"]').bootstrapSwitch(),t.find("input[data-type], textarea[data-type]").each(function(){$(this).attr({"data-inputmask-alias":$(this).attr("data-type"),"data-inputmask-rightAlign":"false"}).removeAttr("data-type").inputmask(),$(this).val($(this).val())}),t.find("input[data-mask], textarea[data-mask]").each(function(){$(this).attr("data-inputmask-mask",$(this).attr("data-mask")).removeAttr("data-mask").inputmask(),$(this).val($(this).val())}),t.find("input[data-regexp], textarea[data-regexp]").each(function(){$(this).attr({"data-inputmask-regex":$(this).attr("data-regexp")}).removeAttr("data-regexp").inputmask(),$(this).val($(this).val())}),t.find("input[data-inputmask], textarea[data-inputmask], input[data-inputmask-alias], textarea[data-inputmask-alias], input[data-inputmask-mask], textarea[data-inputmask-mask], input[data-inputmask-regex], textarea[data-inputmask-regex]").each(function(){$(this).attr("data-inputmask-rightAlign")||$(this).attr("data-inputmask-rightAlign","false"),$(this).inputmask(),$(this).val($(this).val())})},FormHelper.setValuesFromDataAttributes=function(e){e.find("select").each(function(){var e=this.getAttribute("data-value");if(e)if(this.multiple)try{var t=JSON.parse(e);$(this).val(t)}catch(t){$(this).val(e)}else $(this).val(e);$(this).change()})},FormHelper.initForm=function(form,container,onSubmitSuccess,options){var $form=$(form);if(!$form.length)return void console.error("Passed $form argument is not a valid element or selector",$form);var $container=$(container);options||(options={}),options=$.extend({},{isJson:!0,clearForm:!0,onValidationErrors:null,onResponse:null,beforeSubmit:null},options);var customInitiator=$form.attr("data-initiator");if(customInitiator){var ret=null;if(null!==customInitiator.match(/^[a-zA-Z0-9_.$()\[\]]+$/)&&(eval("customInitiator = "+customInitiator),"function"==typeof customInitiator&&(ret=customInitiator.call(form,$form,$container,onSubmitSuccess))),!1===ret)return void $form.trigger("ready.cmfform")}FormHelper.setValuesFromDataAttributes($form),FormHelper.initInputPlugins($form),$form.ajaxForm({clearForm:!!options.clearForm,dataType:options.isJson?"json":"html",beforeSubmit:function(){var e=function(){FormHelper.removeAllFormMessagesAndErrors($form),Utils.showPreloader($container)};"function"==typeof options.beforeSubmit?options.beforeSubmit($form,$container,e):e()},error:function(e){Utils.hidePreloader($container),400!==e.status&&422!==e.status||"function"!=typeof options.onValidationErrors?FormHelper.handleAjaxErrors($form,e,this):options.onValidationErrors(e,$form,$container),"function"==typeof options.onResponse&&options.onResponse($form,$container)},success:function(e){$.isFunction(onSubmitSuccess)?onSubmitSuccess(e,$form,$container):(Utils.hidePreloader($container),options.isJson&&Utils.handleAjaxSuccess(e)),"function"==typeof options.onResponse&&options.onResponse($form,$container)}}),$form.trigger("ready.cmfform")},FormHelper.removeAllFormMessagesAndErrors=function(e){return $.when(FormHelper.removeFormMessage(e),FormHelper.removeFormValidationMessages(e))},FormHelper.setFormMessage=function(e,t,a){a||(a="error"),toastr[a](t)},FormHelper.addFormMessage=function(e,t,a){a||(a="error"),toastr[a](t)},FormHelper.removeFormMessage=function(e){},FormHelper.removeFormValidationMessages=function(e){return e.find(".has-error").removeClass("has-error"),e.find(".error-text").slideUp(FormHelper.messageAnimDurationMs,function(){$(this).html("")})},FormHelper.handleAjaxErrors=function(e,t,a){FormHelper.removeAllFormMessagesAndErrors(e).done(function(){if(400!==t.status&&422!==t.status)Utils.handleAjaxError.call(a,t);else{var n=Utils.convertXhrResponseToJsonIfPossible(t);if(!n)return void Utils.handleAjaxError.call(a,t);var r;if(422!==t.status||n.errors){if(n._message&&FormHelper.setFormMessage(e,n._message),n.errors&&$.isPlainObject(n.errors))for(r in n.errors)FormHelper.showErrorForInput(e,r,n.errors[r])}else{var i=CmfConfig.getLocalizationStringsForComponent("form");i&&i.invalid_data_received&&FormHelper.setFormMessage(e,i.invalid_data_received);for(r in n)FormHelper.showErrorForInput(e,r,n[r])}}})},FormHelper.showErrorForInput=function(e,t,a){if(e[0][t]){var n=null,r=$(e[0][t]);r.attr("data-error-container")&&(n=e.find(r.attr("data-error-container"))),n&&n.length||(n=r.closest(".form-group, .checkbox")),n.addClass("has-error");var i=n.find(".error-text");if(0==i.length){i=$('<div class="error-text bg-danger"></div>').hide();var o=n.find(".help-block");o.length?o.before(i):n.append(i)}$.isArray(a)&&(a=a.join("; ")),i.html(a).slideDown(FormHelper.messageAnimDurationMs);var l=e.find(".nav-tabs");if(l.length){var s=n.closest(".tab-pane").attr("id");s&&l.find('a[href="#'+s+'"]').parent("li").addClass("has-error")}}else FormHelper.addFormMessage(e,t+": "+a,"error")},FormHelper.inputsDisablers={},FormHelper.inputsDisablers.init=function(e,t,a){var n=$(e);if(0!==n.length){$.isArray(t)||console.error("Disablers argument must be a plain array");for(var r=function(e){var t=n.find('[name="'+e+'[]"], [name="'+e+'"]').filter("input, select, textarea");if(0===t.length)return null;if(1===t.length)return t.first();var a=t.not('[type="hidden"]');if(a.length>0)return a.first();var r=t.filter('[name="'+e+'[]"]');return r.length>0?r:t},i=[],o=0;o<t.length;o++){var l=t[o];if($.isPlainObject(l)&&l.input_name&&l.conditions&&$.isArray(l.conditions)&&0!==l.conditions.length){var s=r(l.input_name);if(s){for(var d=!0,c=[],u=0;u<l.conditions.length;u++){var f=l.conditions[u];if(!0===f.force_state){s.prop(f.attribute||"disabled",!0),c=[];break}var p=r(f.disabler_input_name);if(!p){if(f.ignore_if_disabler_input_is_absent)continue;console.error("Enabler input with name '"+f.disabler_input_name+"' or '"+f.disabler_input_name+"[]' were not found in form"),d=!1;break}if(void 0===f.on_value){console.error("No value provided in condition for disabler '"+f.disabler_input_name+"' on input '"+l.input_name),d=!1;break}if(!0!==f.on_value&&!1!==f.on_value){var m=f.on_value.match(/^\/(.*)\/(i?g?m?|i?m?g?|g?m?i?|g?i?m?|m?i?g?|m?g?i?)$/);if(null===m){
console.error("Invalid regexp '"+f.on_value+"' for disabler '"+f.disabler_input_name+"' on input '"+l.input_name+NaN),d=!1;break}f.regexp=new RegExp(m[1],m[2])}f.$disablerInput=p,f.isDisablerInputChecboxOrRadio=p.filter('[type="checkbox"], [type="radio"]').length>0,f.value_is_equals=void 0===f.value_is_equals||!!f.value_is_equals,c.push(f)}if(d&&0!==c.length){l.conditions=c,l.$targetInput=s;for(var h=0;h<l.conditions.length;h++)l.conditions[h]&&l.conditions[h].$disablerInput&&FormHelper.inputsDisablers.setDisablerInputValueChangeEventHandlers(l,l.conditions[h]);i.push(l)}}else console.error("Target input with name '"+l.input_name+"' or '"+l.input_name+"[]' was not found in form")}}n.data("disablers",i),a&&FormHelper.inputsDisablers.onFormDataChanged(n)}},FormHelper.inputsDisablers.setDisablerInputValueChangeEventHandlers=function(e,t){var a=t.$disablerInput;"select"===a.prop("tagName").toLowerCase()?a.on("run-disabler.cmfform change blur",function(){FormHelper.inputsDisablers.handleDisablerInputValueChange(e)}):a.not('[type="checkbox"], [type="radio"]').length>0?a.on("run-disabler.cmfform change blur keyup",function(){FormHelper.inputsDisablers.handleDisablerInputValueChange(e)}):a.on("run-disabler.cmfform change switchChange.bootstrapSwitch",function(){FormHelper.inputsDisablers.handleDisablerInputValueChange(e)})},FormHelper.inputsDisablers.handleDisablerInputValueChange=function(e){var t=e.$targetInput,a=FormHelper.inputsDisablers.isInputMustBeDisabled(e);if(a&&void 0!==a.set_readonly_value&&null!==a.set_readonly_value&&(t.not('[type="checkbox"], [type="radio"]').length>0?t.val(a.set_readonly_value).change():t.attr("type")&&"checkbox"===t.attr("type").toLowerCase()&&1===t.length?t.prop("checked",!!a.set_readonly_value).change():t.prop("checked",!1).filter('[value="'+a.set_readonly_value+'"]').prop("checked",!0).end().change()),t.hasClass("selectpicker"))a?t.prop({disabled:!0,readOnly:!0}):t.prop({disabled:!1,readOnly:!1}),t.selectpicker("refresh");else if(t.attr("data-editor-name")){var n=CKEDITOR.instances[t.attr("data-editor-name")];n&&n.setReadOnly(!!a)}else t.hasClass("switch")&&(a?t.bootstrapSwitch(a.attribute,!0):(t.bootstrapSwitch("readonly",!1),t.bootstrapSwitch("disabled",!1)));t.prop({disabled:!1,readOnly:!1}),a&&t.prop(a.attribute,!0),t.change()},FormHelper.inputsDisablers.isInputMustBeDisabled=function(e){for(var t=0;t<e.conditions.length;t++){var a=e.conditions[t],n=!1,r=!1;if(a.isDisablerInputChecboxOrRadio)if("checkbox"===a.$disablerInput.attr("type").toLowerCase()&&1===a.$disablerInput.length)n=a.$disablerInput.prop("checked")===!!a.on_value;else{for(var i=0;i<a.$disablerInput.filter(":checked").length;i++)if(a.regexp.test($(this).val())){if(a.value_is_equals){n=!0;break}}else if(!a.value_is_equals){n=!0;break}r=!0}else n=a.regexp?a.regexp.test(a.$disablerInput.val()):a.$disablerInput.val()===(a.on_value?"1":"0");if(r||a.value_is_equals||(n=!n),n)return a}return null},FormHelper.inputsDisablers.onFormDataChanged=function(e){var t=$(e).data("disablers");if(t&&$.isArray(t))for(var a=0;a<t.length;a++)if(t[a]&&t[a].conditions&&$.isArray(t[a].conditions))for(var n=0;n<t[a].conditions.length;n++)t[a].conditions[n]&&t[a].conditions[n].$disablerInput&&t[a].conditions[n].$disablerInput.trigger("run-disabler.cmfform")};var AdminUI={$el:null,visible:!1,loaded:!1,userInfoTplSelector:"#user-panel-tpl",userInfoTpl:null,userInfoContainer:"#user-panel .info"};AdminUI.destroyUI=function(){var e=$.Deferred();if(AdminUI.visible){var t=Utils.getPageWrapper();AdminUI.stopMenuCountersUpdates(),t.fadeOut(CmfConfig.contentChangeAnimationDurationMs,function(){AdminUI.$el&&AdminUI.$el.detach(),t.removeClass("with-ui").empty(),t.show(),AdminUI.visible=!1,e.resolve(),$(document).trigger("appui:hidden")})}else e.resolve();return e.promise()},AdminUI.showUI=function(){var e=$.Deferred(),t=Utils.getPageWrapper();return AdminUI.visible?e.resolve():AdminUI.loaded?(AdminUI.visible=!0,AdminUI.updateUserInfo(),t.fadeIn(CmfConfig.contentChangeAnimationDurationMs),e.resolve(),AdminUI.startMenuCountersUpdates(),$(document).trigger("appui:shown")):(Utils.showPreloader(t),$.when(AdminUI.loadUI(),t.fadeOut(CmfConfig.contentChangeAnimationDurationMs)).done(function(a){t.addClass("with-ui").empty().append(a),AdminUI.visible=!0,AdminUI.updateUserInfo(),t.fadeIn(CmfConfig.contentChangeAnimationDurationMs),e.resolve(),AdminUI.startMenuCountersUpdates(),$(document).trigger("appui:shown")}).fail(function(t){e.reject(t)})),e.promise()},AdminUI.loadUI=function(){var e=$.Deferred();return AdminUI.loaded?e.resolve(AdminUI.$el):Utils.downloadHtml(CmfConfig.uiUrl,!0,!1).done(function(t){AdminUI.loaded=!0,AdminUI.$el=$('<div class="ui-container"></div>').html(t),e.resolve(AdminUI.$el),AdminUI.initMenuCountersUpdatesAfterAjaxRequests(),AdminUI.initCustomScrollbars(AdminUI.$el),$(document).trigger("appui:loaded")}).fail(function(t){e.reject(t)}),e.promise()},AdminUI.initCustomScrollbars=function(e){var t=e.find("[ss-container]");if(t.length){var a=null,n={subtree:!0,childList:!0,attributes:!0,attributeFilter:["style","class"]};"undefined"!=typeof MutationObserver&&(a=new MutationObserver(function(e){var t=$(e[0].target).closest(".ss-container");t.length&&t[0].hasOwnProperty("data-simple-scrollbar")&&t[0]["data-simple-scrollbar"].moveBar()}));for(var r=0;r<t.length;r++)t[r].hasOwnProperty("data-simple-scrollbar")||Object.defineProperty(t[r],"data-simple-scrollbar",{value:new SimpleScrollbar(t[r])}),a&&a.observe($(t[r]).find(".ss-content")[0],n)}},AdminUI.updateUserInfo=function(e){if(AdminUI.visible){if(!e)return void Utils.getUser().done(function(e){AdminUI.updateUserInfo(e)});var t=$(AdminUI.userInfoContainer);if(AdminUI.userInfoTpl)t.html(AdminUI.userInfoTpl(e)).removeClass("fade-out");else{t.addClass("fading fade-out").width();var a=$(AdminUI.userInfoTplSelector);a.length&&Utils.makeTemplateFromText(a.html(),"User Info block template").done(function(a){AdminUI.userInfoTpl=a,t.html(AdminUI.userInfoTpl(e)).removeClass("fade-out"),$(document).on("change:user",function(e,t){AdminUI.updateUserInfo(t)})}).fail(function(e){throw e})}}},AdminUI.initMenuCountersUpdatesAfterAjaxRequests=function(){CmfConfig.enableMenuCounters&&$(document).ajaxSuccess(function(e,t,a){(-1!==$.inArray(a.type,["POST","PUT","DELETE"])||null!==a.url.match(/_method=(POST|PUT|DELETE)/)||$.isPlainObject(a.data)&&a.data._method&&-1!==$.inArray(a.data._method,["POST","PUT","DELETE"])||"string"==typeof a.data&&null!==a.data.match(/_method=(POST|PUT|DELETE)/))&&AdminUI.updateMenuCounters()})},AdminUI.menuCountersInterval=null,AdminUI.startMenuCountersUpdates=function(){!AdminUI.menuCountersInterval&&CmfConfig.enableMenuCounters&&(AdminUI.updateMenuCounters(),AdminUI.menuCountersInterval=setInterval(AdminUI.updateMenuCounters,CmfConfig.menuCountersUpdateIntervalMs))},AdminUI.stopMenuCountersUpdates=function(){AdminUI.menuCountersInterval&&(clearInterval(AdminUI.menuCountersInterval),AdminUI.menuCountersInterval=null)},AdminUI.disableMenuCountersUpdates=function(){CmfConfig.enableMenuCounters=!1,AdminUI.stopMenuCountersUpdates()},AdminUI.updateMenuCounters=function(){var e=$.Deferred();return AdminUI.visible&&CmfConfig.enableMenuCounters?($.ajax({url:CmfConfig.menuCountersDataUrl,cache:!1,dataType:"json",method:"GET"}).done(function(t){if($.isPlainObject(t)&&!$.isEmptyObject(t))$(document).find("[data-counter-name]").each(function(){var e=$.trim($(this).data("counter-name"));e&&t[e]&&$(this).html(t[e])});else if(CmfConfig.disableMenuCountersIfEmptyOrInvalidDataReceived)return AdminUI.disableMenuCountersUpdates(),void e.resolve({});e.resolve(t)}).fail(function(t){Utils.handleAjaxError.call(this,t,e),AdminUI.stopMenuCountersUpdates(),CmfConfig.disableMenuCountersIfEmptyOrInvalidDataReceived&&AdminUI.disableMenuCountersUpdates()}),e.promise()):e.resolve({})};var Utils={bodyClass:!1,loadedJsFiles:{},loadedCssFiles:{},cacheLoadedJsFiles:!0,modalTpl:null,modalsCount:0};Utils.configureAppLibs=function(){Utils.configureAjax(),Utils.configureToastr(),void 0!==$.inputmask&&($.inputmask.defaults.rightAlign=!1,$.inputmask.defaults.rightAlignNumerics=!1)},Utils.configureToastr=function(){toastr.options=CmfConfig.toastrOptions},Utils.configureAjax=function(){$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),CmfConfig.isDebug&&$(document).ajaxComplete(function(e,t,a){var n=a.url.replace(/\?.*$/,""),r=a.url.replace(/^.*\?(.*)$/,"$1");if(console.group("Ajax: %s %s",a.type||"GET",n,t.status,t.statusText),r.length>0){var i=$.extend(page.queryString(r),"GET"!==a.type?{}:a.data||{});delete i._,$.isEmptyObject(i)||(console.groupCollapsed("GET"),console.log(i),console.groupEnd())}"POST"===a.type&&(console.groupCollapsed("POST"),$.isPlainObject(a.data)||$.isArray(a.data)?console.log(a.data):console.log(page.queryString(a.data)),console.groupEnd()),console.groupCollapsed("Response");var o=Utils.convertXhrResponseToJsonIfPossible(t);console.log(o||t.responseText),console.groupEnd(),console.groupEnd()})},Utils.convertXhrResponseToJsonIfPossible=function(e){if(e.responseText&&e.responseText.length>=2&&("{"===e.responseText[0]||"["===e.responseText[0]))try{return JSON.parse(e.responseText)}catch(e){}return!1},Utils.requireFiles=function(e,t){var a=$.Deferred(),n=0;if(void 0!==e){$.isArray(e)||("string"==typeof e?e=[e]:(console.trace(),alert("jsFiles argument in Utils.requireFiles() must be a string or array")));for(var r=0;r<e.length;r++){"string"!=typeof e[r]&&alert("jsFiles argument in Utils.requireFiles() must contain only strings. Not a string detected in index "+r);var i=e[r].replace(/(\?|&)_=[0-9]+/,"");if(Utils.cacheLoadedJsFiles){if(Utils.loadedJsFiles[i]){Utils.loadedJsFiles[i].done(function(){n++,e.length===n&&a.resolve()});continue}if($('script[src^="'+i+'"]').length){Utils.loadedJsFiles[i]=$.Deferred().resolve().promise(),n++,e.length===n&&a.resolve();continue}}Utils.loadedJsFiles[i]=$.getScript(e[r]).done(function(t,r,i){n++,e.length===n&&a.resolve()}).fail(function(e,t,n){alert("Failed to load js file "+this.url+". Error: "+n),a.reject(n)})}}else a.resolve();if(void 0!==t&&($.isArray(t)||("string"==typeof t?t=[t]:(console.trace(),alert("cssFiles argument in Utils.requireFiles() must be a string or array"))),t&&$.isArray(t)))for(r=0;r<t.length;r++){"string"!=typeof t[r]&&alert("cssFiles argument in Utils.requireFiles() must contain only strings. Not a string detected in index "+r);var o=t[r].replace(/(\?|&)_=[0-9]+/,"");Utils.loadedCssFiles[o]||$('link[href^="'+o+'"]').length?Utils.loadedCssFiles[o]=!0:document.createStyleSheet?document.createStyleSheet(t[r]):($("body").before($('<link rel="stylesheet" href="'+t[r]+'" type="text/css" />')),Utils.loadedCssFiles[o]=!0)}return a.promise()},Utils.handleAjaxError=function(e,t){var a="object"==typeof t&&"function"==typeof t.reject;if(e.status>=400&&a&&t.reject(new Error(this.url+": "+e.statusText+"; Response: "+e.responseText,e.status)),419===e.status)return toastr.error(CmfConfig.getLocalizationString("error.csrf_token_missmatch","Your session has timed out. Page will be reloaded in 5 seconds.")),setTimeout(function(){document.location.reload(!0)},5e3),void Utils.showPreloader($(document.body));var n=Utils.convertXhrResponseToJsonIfPossible(e);if(!(n&&(n.redirect_with_reload?document.location=n.redirect_with_reload:n.redirect&&("back"===n.redirect?(a&&t.reject(),page.back(n.redirect_fallback)):"/"===n.redirect[0]?(a&&t.reject(),page.show(n.redirect)):document.location=n.redirect),(n._message||n.error)&&toastr.error(n._message||n.error),n.redirect||n.redirect_with_reload||n._message||n.error))){var r=this.url||null;return 0===e.status?(toastr.error("Request to "+r+" failed. Reason: no internet connection"),void(a&&t.reject())):200===e.status&&""===e.responseText?(toastr.info("Empty response from "+r+". Possibly debug session was stopped."),void(a&&t.reject())):void(0===e.responseText.length||void 0===CmfConfig?toastr.error("HTTP Error "+e.status+" "+e.statusText):CmfConfig.getDebugDialog().showDebug("HTTP Error "+e.status+" "+e.statusText,n||e.responseText))}},Utils.handleAjaxSuccess=function(e){try{if(e.redirect_with_reload)document.location=e.redirect_with_reload;else if(e.redirect){var t="undefined"!=typeof page&&"function"==typeof page.show;switch(e.redirect){case"back":t?page.back(e.redirect_fallback):document.location=e.redirect_fallback||"/";break;case"reload":t?page.reload():document.location.reload();break;default:t?page.show(e.redirect,null,!0,!0,{env:{is_ajax_response:!0}}):document.location=e.redirect}}}catch(e){console.error(e.name+": "+e.message),console.error(e.stack)}if(e._message&&toastr.success(e._message),e._reload_user&&Utils.getUser(!0),e.modal&&$.isPlainObject(e.modal)&&void 0!==e.modal.content){var a=Utils.makeModal(e.modal.title||"",e.modal.content,e.modal.footer||"",e.modal.size||"medium");e.repeat_action&&"function"==typeof e.repeat_action&&a.find(".reload-url-button, .reload").removeClass("hidden").on("click",function(t){return t.preventDefault(),a.one("hide.bs.modal",function(){e.repeat_action()}).modal("hide"),!1}),$(document.body).append(a),a.one("hidden.bs.modal",function(){a.remove()}).modal({show:!0,backdrop:"static"}).on("shown.bs.modal",function(){$("body").addClass("modal-open")}).find('[data-toggle="tooltip"]').tooltip()}},Utils.handleMissingContainerError=function(){document.location.reload()},Utils.showPreloader=function(e){e&&$(e).addClass("has-preloader loading")},Utils.hidePreloader=function(e){e&&$(e).removeClass("loading")},Utils.hasActivePreloader=function(e){return e&&$(e).hasClass("has-preloader loading")},Utils.fadeOut=function(e,t){$(document.body).queue(function(a){e.fadeOut(CmfConfig.contentChangeAnimationDurationMs,function(){$.isFunction(t)&&t(e),a()})})},Utils.fadeIn=function(e,t){$(document.body).queue(function(a){$.isFunction(t)&&t(e),e.fadeIn(CmfConfig.contentChangeAnimationDurationMs,a)})},Utils.switchBodyClass=function(e,t,a){Utils.removeBodyClass(),e&&(e=Utils.normalizeBodyClass(e),$(document.body).addClass(e),Utils.bodyClass=e),t&&$(document.body).attr("data-section",t),a&&$(document.body).attr("data-item-pk",a)},Utils.normalizeBodyClass=function(e){return e.replace(/[^a-zA-Z0-9 ]+/g,"-")},Utils.getBodyClass=function(){return Utils.bodyClass},Utils.getCurrentSectionName=function(){return $(document.body).attr("data-section")},Utils.removeBodyClass=function(){Utils.bodyClass&&($(document.body).removeClass(Utils.bodyClass),Utils.bodyClass=!1),$(document.body).removeAttr("data-section").removeAttr("data-item-pk").find("> .tooltip").remove()},Utils.getPageWrapper=function(){var e=$("#page-wrapper");return!!e.length&&(Utils.getPageWrapper=function(){return e},e)},Utils.getContentContainer=function(){var e=$("#section-content");return!!e.length&&(Utils.getContentContainer=function(){return e},e)},Utils.getAvailableContentContainer=function(){var e=Utils.getContentContainer();return e||(e=Utils.getPageWrapper()),e},Utils.makeTemplateFromText=function(e,t){var a=$.Deferred();try{var n=doT.template(e);a.resolve(function(a){try{return n(a)}catch(n){var r="Failed to render doT.js template"+(t?" ("+t+")":""),i="<h1>"+n.name+": "+n.message+"</h1><pre>"+n.stack+"</pre><h2>Template:</h2><pre>"+$("<div/>").text(e).html()+"</pre><h2>Data:</h2><pre>"+JSON.stringify(a,null,"   ")+"</pre>";return CmfConfig.getDebugDialog().showDebug(r,i),""}})}catch(n){var r="Failed to convert text into doT.js template"+(t?" ("+t+")":""),i="<h1>"+n.name+": "+n.message+"</h1><pre>"+n.stack+"</pre><h2>Template:</h2>";CmfConfig.getDebugDialog().showDebug(r,i+"<pre>"+$("<div/>").text(e).html()+"</pre>"),a.reject(new Error(r))}return a.promise()},Utils.downloadHtml=function(e,t,a,n){var r=$.Deferred();return e&&e.length?(e=("/"===e[0]||null!==e.match(/^https?:/)?e:CmfConfig.rootUrl+"/"+e).replace(/\.html$/i,"")+".html","string"==typeof n&&n.length>1&&(e+="?"===n[0]?n:"?"+n),t&&CmfCache.views[e]?r.resolve(CmfCache.views[e]):$.ajax({url:e,cache:!1,dataType:"html",method:"GET"}).done(function(n){a?Utils.makeTemplateFromText(n,e).done(function(a){t&&(CmfCache.views[e]=a),r.resolve(a)}).fail(function(e){r.reject(e)}):(t&&(CmfCache.views[e]=n),r.resolve(n))}).fail(function(e){Utils.handleAjaxError.call(this,e,r)}),r.promise()):(console.warn("Empty url received in Utils.downloadHtml()"),console.trace(),r.reject(new Error("Empty url received in Utils.downloadHtml()")),r.promise())},Utils.userDataIsLoading=!1,Utils.getUser=function(e){var t=$.Deferred();return e||!CmfCache.user||Math.abs((new Date).getMilliseconds()-CmfCache.userLastUpdateMs)>CmfConfig.userDataCacheTimeoutMs?$.ajax({url:CmfConfig.userDataUrl,cache:!1,dataType:"json",method:"GET"}).done(function(e){var a=Utils.setUser(e);t.resolve(a)}).fail(function(e){Utils.handleAjaxError.call(this,e,t)}):t.resolve(CmfCache.user),t.promise()},Utils.setUser=function(e){return CmfCache.user=e,CmfCache.userLastUpdateMs=(new Date).getMilliseconds(),$(document).trigger("change:user",CmfCache.user),CmfCache.user},Utils.highlightLinks=function(e){if(e&&e.pathname&&!e.is_dialog){var t=e.pathname;$("li.current-page, a.current-page, li.treeview").removeClass("current-page active");var a=$('a[href="'+t+'"], a[href="'+document.location.origin+t+'"]');if(a.length&&(a.parent().filter("li").addClass("current-page active").parent().filter("ul.treeview-menu").addClass("menu-open").parent().filter("li.treeview").addClass("active"),a.not("li").find("> a").addClass("current-page active")),!$(".sidebar-menu li.current-page.active").length){var n=t.replace(/(\/page|resource\/[^\/]+)(\/.+)$/,"$1");null===n.match(/(page|resource)$/)&&(a=$('.sidebar-menu a[href="'+n+'"], a[href="'+document.location.origin+n+'"]'),a.length&&(a.parent().filter("li").addClass("current-page active").parent().filter("ul.treeview-menu").addClass("menu-open").parent().filter("li.treeview").addClass("active"),a.not("li").find("> a").addClass("current-page active")))}}},Utils.cleanCache=function(){},Utils.updatePageTitleFromH1=function(e){var t=e&&e.length?e.find("h1, .modal-header").first():$("#section-content h1, h1").first();if(t.length){var a=t.find(".page-title, .modal-title"),n=$.trim(String(CmfConfig.pageTitleAddition));document.title=(a.length?a.text():t.text())+(n.length?" - "+n:"")}else document.title=$.trim(String(CmfConfig.defaultPageTitle))},Utils.getTitleFromContent=function(e){var t=e.find("h1, .modal-header").first();if(t.length){var a=t.find(".page-title, .modal-title");return a.length?a.text():t.text()}return""},Utils.initDebuggingTools=function(){if(CmfConfig.isDebug){$(document.body).addClass("debug");var e=$('<button type="button" class="btn btn-xs btn-default">&nbsp;</button>').css({width:"14px",cursor:"default","background-color":"transparent",border:"0 none",margin:"0",position:"absolute",top:"0",right:"0",opacity:"0","z-index":50}).on("click",function(){t.toggle(),Modernizr.localstorage&&localStorage.setItem("debug-tools-opened",t.height()>0)}),t=$('<div class="btn-group" role="group"></div>').css({position:"absolute",top:"0",right:"14px",width:"192px"}).hide();Modernizr.localstorage&&(localStorage.getItem("debug-tools-opened")||localStorage.getItem("debug-tools-templates-cache-disabled")||localStorage.getItem("debug-tools-js-files-cache-disabled"))&&t.show();var a=$('<div id="debug-tools"></div>').css({position:"absolute",top:"-4px",right:"0",overflow:"visible","z-index":10}).append(e).append(t);$(document.body).append(a);var n=$('<button type="button" class="btn btn-xs btn-default">Tpl cache: on</button>');t.append(n),Modernizr.localstorage&&(ScaffoldsManager.cacheTemplates="off"!==localStorage.getItem("debug-tools-templates-cache")),ScaffoldsManager.cacheTemplates||n.addClass("btn-danger").removeClass("btn-default").text("Tpl cache: off"),n.on("click",function(){ScaffoldsManager.cacheTemplates=!ScaffoldsManager.cacheTemplates;var e=ScaffoldsManager.cacheTemplates?"on":"off";n.addClass(ScaffoldsManager.cacheTemplates?"btn-default":"btn-danger").removeClass(ScaffoldsManager.cacheTemplates?"btn-danger":"btn-default").text("Tpl cache: "+e),Modernizr.localstorage&&localStorage.setItem("debug-tools-templates-cache",e)});var r=$('<button type="button" class="btn btn-xs btn-default">JS files cache: on</button>');t.append(r),Modernizr.localstorage&&(Utils.cacheLoadedJsFiles="off"!==localStorage.getItem("debug-tools-js-files-cache")),Utils.cacheLoadedJsFiles||r.addClass("btn-danger").removeClass("btn-default").text("JS files cache: off"),r.on("click",function(){Utils.cacheLoadedJsFiles=!Utils.cacheLoadedJsFiles;var e=Utils.cacheLoadedJsFiles?"on":"off";r.addClass(Utils.cacheLoadedJsFiles?"btn-default":"btn-danger").removeClass(Utils.cacheLoadedJsFiles?"btn-danger":"btn-default").text("JS files cache: "+e),Modernizr.localstorage&&localStorage.setItem("debug-tools-js-files-cache",e)})}},Utils.makeModal=function(e,t,a,n,r){Utils.modalTpl||(Utils.modalTpl=doT.template($("#modal-template").html())),Utils.modalsCount++;var i={id:r||"cmf-custom-modal-"+Utils.modalsCount,title:e,content:t,footer:a,size:n};return $(Utils.modalTpl(i))},Utils.copyToClipboardFrom=function(e,t){var a=$(e);if(a.length){var n=document.createRange();n.selectNodeContents(a[0]);var r=window.getSelection();return r.removeAllRanges(),r.addRange(n),document.execCommand("copy"),r.removeAllRanges(),t&&t.length&&toastr.info(t.replace(/:text/g,a.text())),!1}};var CmfRoutingHelpers={lastNonModalPageRequest:null,$currentContentContainer:Utils.getPageWrapper(),$currentContent:null,pageExitTransition:function(e,t){return t.env().is_restore||Utils.showPreloader(CmfRoutingHelpers.$currentContentContainer),CmfRoutingHelpers.hideModals()},hideContentContainerPreloader:function(){Utils.hidePreloader(Utils.getPageWrapper()),Utils.hidePreloader(Utils.getContentContainer()),Utils.hidePreloader(CmfRoutingHelpers.$currentContentContainer)},cleanupHangedElementsInBody:function(){$("body > .tooltip, body > .bs-container.bootstrap-select").remove(),$("body > div > .g-recaptcha-bubble-arrow").parent().remove()},cleanupHangedElementsInContentWrapper:function(){Utils.getContentContainer().find(".tooltip, .bs-container.bootstrap-select").remove()},hideModals:function(){var e=$.Deferred();return CmfRoutingHelpers.$currentContent&&CmfRoutingHelpers.$currentContent.hasClass("modal")?CmfRoutingHelpers.$currentContent.data("closed-automatically","1").one("hidden.bs.modal",function(){e.resolve()}).modal("hide"):e.resolve(),e.promise()},routeHandled:function(e){e.title=document.title,CmfRoutingHelpers.$currentContent.hasClass("modal")||e.env().is_restore||(CmfRoutingHelpers.lastNonModalPageRequest=e,Utils.highlightLinks(e)),CmfRoutingHelpers.hideContentContainerPreloader()},setCurrentContentContainer:function(e){CmfRoutingHelpers.$currentContentContainer&&CmfRoutingHelpers.$currentContentContainer.is(e)||(Utils.hasActivePreloader(CmfRoutingHelpers.$currentContentContainer)&&(CmfRoutingHelpers.hideContentContainerPreloader(),Utils.showPreloader(e)),CmfRoutingHelpers.$currentContentContainer=e)},wrapContent:function(e){return"string"==typeof e?$("<div>").addClass(CmfConfig.contentWrapperCssClass).html(e):"function"==typeof e?e.jquery?e:$("<div>").addClass(CmfConfig.contentWrapperCssClass).html(e()):(console.error("CmfRoutingHelpers.wrapContent(): html argument is not a string, jquery element of function"),!1)},setCurrentContent:function(e,t){var a=$.Deferred(),n=CmfRoutingHelpers.wrapContent(e);if(!1===n)return a.reject(new Error("Failed to wrap content")),a.promise();n.hide(),t&&CmfRoutingHelpers.setCurrentContentContainer(t),Utils.updatePageTitleFromH1(n);var r=function(e,t){CmfRoutingHelpers.$currentContent=e,CmfRoutingHelpers.$currentContentContainer.html("").append(e),t.resolve(CmfRoutingHelpers.$currentContent),Utils.fadeIn(CmfRoutingHelpers.$currentContent,function(){CmfRoutingHelpers.hideContentContainerPreloader()})};return CmfRoutingHelpers.$currentContent?CmfRoutingHelpers.$currentContent.is(n)?(CmfRoutingHelpers.hideContentContainerPreloader(),a.resolve(n)):Utils.fadeOut(CmfRoutingHelpers.$currentContent,function(){CmfRoutingHelpers.$currentContent.remove(),r(n,a)}):r(n,a),a.promise()},initModalAndContent:function(e,t){var a=$.Deferred();if(t.convertToSubrequest(),!CmfRoutingHelpers.$currentContent)return CmfConfig.getDebugDialog().showDebug("Unexpected application behavior detected","Current content is not defined yet. Possibly you're trying to show content in modal dialog instead of current page. Trace printed to console."),console.trace(),a.reject(new Error("Current content is not defined yet")),a.promise();if(CmfRoutingHelpers.$currentContent.hasClass("modal"))return CmfRoutingHelpers.hideModals().done(function(){CmfRoutingHelpers.initModalAndContent(e,t).done(function(){a.resolve(e)})}),a.promise();var n=CmfRoutingHelpers.$currentContentContainer,r=CmfRoutingHelpers.$currentContent;return e.modal({backdrop:"static",show:!1}).on("hide.bs.modal",function(){var a=!!e.data("closed-automatically");CmfRoutingHelpers.$currentContent=r,CmfRoutingHelpers.setCurrentContentContainer(n),a||t.restoreParentRequest(!0)}).on("hidden.bs.modal",function(){e.remove()}).on("show.bs.modal",function(){CmfRoutingHelpers.$currentContent=e,CmfRoutingHelpers.setCurrentContentContainer(e.find(".modal-dialog")),Utils.updatePageTitleFromH1(e)}).on("shown.bs.modal",function(){$("body").addClass("modal-open")}),$(document.body).append(e),a.resolve(e),a.promise()},closeCurrentModalAndReloadDataGrid:function(){CmfRoutingHelpers.hideModals(),ScaffoldDataGridHelper.reloadCurrentDataGrid()},renderModalFromHtml:function(e,t,a,n,r){var i=CmfRoutingHelpers.wrapContent(t),o=i.find(".modal-footer").remove(),l=Utils.getTitleFromContent(i);i.find(".content-header").remove(),i.find("h1").remove();var s=null;i.find(".content").length&&(i=i.find(".content").removeClass("content"),s=i.attr("data-modal-size")),s||(s=n||"large");var d=Utils.makeModal(l,i[0].outerHTML,o.length?o.html():null,s,a+"modal");r&&d.find(".reload-url-button").removeClass("hidden"),CmfRoutingHelpers.initModalAndContent(d,e).done(function(){d.find(".reload-url-button, .open-url-in-new-tab-button").attr("href",e.makeUrlToUseItInParentRequest()).attr("data-modal","1"),ScaffoldActionsHelper.initActions(d),d.modal("show"),$(document.body).attr("data-modal-opened","1")}),CmfRoutingHelpers.hideContentContainerPreloader()}},CmfRouteChange={};CmfRouteChange.authorizationPage=function(e){return e.hasSubRequest()&&(e.removeSubRequest(),e.saveState()),$.when(Utils.downloadHtml(e.pathname,!0,!1,e.querystring),AdminUI.destroyUI()).done(function(t){CmfRoutingHelpers.setCurrentContent(t,Utils.getPageWrapper()).done(function(t){Utils.switchBodyClass("login-page cmf-"+e.path.replace(/[^a-zA-Z0-9]+/,"-").toLowerCase()+"-page","authorization");var a=t.find("form");a.length&&FormHelper.initForm(a,CmfRoutingHelpers.$currentContentContainer,function(e){Utils.cleanCache(),Utils.handleAjaxSuccess(e)})}),CmfRoutingHelpers.routeHandled(e)}).promise()},CmfRouteChange.logout=function(e){Utils.showPreloader(document.body),Utils.getPageWrapper().fadeOut(500),document.location=e.fullUrl()},CmfRouteChange.showPage=function(e){var t=function(){Utils.switchBodyClass("page-"+e.params.uri.replace(/[^a-zA-Z0-9]+/,"-"),"page")};if(e.env().is_restore||e.env().is_history&&e.hasSamePathAs(page.previousRequest()))return CmfRoutingHelpers.routeHandled(e),t(),void Utils.updatePageTitleFromH1(Utils.getContentContainer());var a=e.isSubRequest();!a&&e.env().is_click&&e.env().target&&$(e.env().target).attr("data-modal")&&(a=!0);var n=e.querystring;return a&&(n&&n.length>1?n+="&modal=1":n="modal=1"),$.when(Utils.downloadHtml(e.pathname,!1,!1,n),AdminUI.showUI()).done(function(n){if(a){var r="page-"+e.params.page;CmfRoutingHelpers.renderModalFromHtml(e,n,r,"large",!0)}else CmfRoutingHelpers.setCurrentContent(n,Utils.getContentContainer()).done(function(){t()});CmfRoutingHelpers.routeHandled(e)})},CmfRouteChange.scaffoldResourceCustomPage=function(e){var t=function(){e.params.id?Utils.switchBodyClass(ScaffoldActionsHelper.makeResourceBodyClass(e.params.resource)+" resource-item-page-"+e.params.page,"resource:item-page",e.params.id):Utils.switchBodyClass(ScaffoldActionsHelper.makeResourceBodyClass(e.params.resource)+" resource-page-"+e.params.page,"resource:page")};if(e.env().is_restore||e.env().is_history&&e.hasSamePathAs(page.previousRequest()))return CmfRoutingHelpers.routeHandled(e),t(),void Utils.updatePageTitleFromH1(Utils.getContentContainer());var a=e.isSubRequest();!a&&e.env().is_click&&e.env().target&&$(e.env().target).attr("data-modal")&&(a=!0);var n=e.querystring;return a&&(n&&n.length>1?n+="&modal=1":n="modal=1"),$.when(Utils.downloadHtml(e.pathname,!1,!1,n),AdminUI.showUI()).done(function(n){if(a){var r=ScaffoldActionsHelper.makeResourceBodyClass(e.params.resource);e.params.id&&(r+="-item"),r+="-page-"+e.params.page,CmfRoutingHelpers.renderModalFromHtml(e,n,r,"large",!0)}else CmfRoutingHelpers.setCurrentContent(n,Utils.getContentContainer()).done(function(){t()});CmfRoutingHelpers.routeHandled(e)})},CmfRouteChange.scaffoldDataGridPage=function(e){var t=function(){Utils.switchBodyClass(ScaffoldActionsHelper.makeResourceBodyClass(e.params.resource),"resource:table")};return e.customData.is_state_save||e.env().is_restore||e.env().is_history&&e.hasSamePathAs(page.previousRequest())?(CmfRoutingHelpers.routeHandled(e),t(),void Utils.updatePageTitleFromH1(Utils.getContentContainer())):e.env().is_click||e.env().is_reload||!CmfRoutingHelpers.lastNonModalPageRequest||CmfRoutingHelpers.lastNonModalPageRequest.pathname!==e.pathname?$.when(ScaffoldsManager.getDataGridTpl(e.params.resource),AdminUI.showUI()).done(function(a){CmfRoutingHelpers.setCurrentContent(a,Utils.getContentContainer()).done(function(){t()}),CmfRoutingHelpers.routeHandled(e)}):(Utils.updatePageTitleFromH1(CmfRoutingHelpers.$currentContent),CmfRoutingHelpers.hideContentContainerPreloader(),void(CmfRoutingHelpers.lastNonModalPageRequest.querystring!==e.querystring?ScaffoldDataGridHelper.reloadStateOfCurrentDataGrid(function(){CmfRoutingHelpers.routeHandled(e)}):CmfRoutingHelpers.routeHandled(e)))},CmfRouteChange.scaffoldItemDetailsPage=function(request){var switchBodyClass=function(){Utils.switchBodyClass(ScaffoldActionsHelper.makeResourceBodyClass(request.params.resource),"resource:details",request.params.id)};return request.env().is_restore||request.env().is_history&&request.hasSamePathAs(page.previousRequest())?(CmfRoutingHelpers.routeHandled(request),switchBodyClass(),void Utils.updatePageTitleFromH1(Utils.getContentContainer())):$.when(ScaffoldsManager.getItemDetailsTpl(request.params.resource),ScaffoldsManager.getResourceItemData(request.params.resource,request.params.id,!0),AdminUI.showUI()).done(function(dotJsTpl,data){var initContent=function($content){ScaffoldActionsHelper.initActions($content);var customInitiator=$content.find(".item-details-tabsheet-container").attr("data-initiator");customInitiator&&null!==customInitiator.match(/^[a-zA-Z0-9_.$()\[\]]+$/)&&(eval("customInitiator = "+customInitiator),"function"==typeof customInitiator&&customInitiator.call($content))};if(request.isSubRequest()||data.__modal&&request.env().is_click&&!1!==request.env().is_modal){data.__modal=!0;var $content=$("<div></div>").html(dotJsTpl(data));if(!1!==$content){var $modal=$content.find(".modal");CmfRoutingHelpers.initModalAndContent($modal,request).done(function(){initContent($modal),$modal.modal("show"),$(document.body).attr("data-modal-opened","1");var e=ScaffoldDataGridHelper.getCurrentDataGridApi();if(e&&data.DT_RowId&&e.settings()[0].resourceName===request.params.resource){var t=ScaffoldDataGridHelper.getCurrentDataGridApi(),a=t.row("#"+data.DT_RowId).index(),n=$modal.find("button.prev-item"),r=$modal.find("button.next-item"),i=1;do{var o=t.row(a+i);if(!o.length||o.data().___details_allowed&&o.data().___details_url)break;i++}while(o.length);o.length?r.prop("disabled",!1).on("click",function(){event.preventDefault(),n.prop("disabled",!0),r.prop("disabled",!0),
page.show(o.data().___details_url,null,!0,!0,{env:{is_click:!0,target:r[0],clarify:"next-item-details"}})}):r.prop("disabled",!0);do{var l=t.row(a-1);if(!l.length||l.data().___details_allowed&&l.data().___details_url)break;i++}while(l.length);l.length?n.prop("disabled",!1).on("click",function(e){e.preventDefault(),n.prop("disabled",!0),r.prop("disabled",!0),page.show(l.data().___details_url,null,!0,!0,{env:{is_click:!0,target:n[0],clarify:"prev-item-details"}})}):n.prop("disabled",!0)}})}CmfRoutingHelpers.hideContentContainerPreloader()}else data.__modal=!1,CmfRoutingHelpers.setCurrentContent(dotJsTpl(data),Utils.getContentContainer()).done(function(e){switchBodyClass(),initContent(e)});CmfRoutingHelpers.routeHandled(request)})},CmfRouteChange.scaffoldItemFormPage=function(e){var t=function(){Utils.switchBodyClass(ScaffoldActionsHelper.makeResourceBodyClass(n),"resource:form",a)};if(e.env().is_restore||e.env().is_history&&e.hasSamePathAs(page.previousRequest()))return CmfRoutingHelpers.routeHandled(e),t(),void Utils.updatePageTitleFromH1(Utils.getContentContainer());var a=e.params.id&&"create"!==e.params.id?e.params.id:null,n=e.params.resource,r=!!e.env().is_clone;return $.when(ScaffoldsManager.getItemFormTpl(n),ScaffoldsManager.getResourceItemData(n,a,!1),ScaffoldFormHelper.loadOptions(n,a),AdminUI.showUI()).done(function(i,o,l){o._is_cloning=r,o._is_creation=o._is_cloning||!a;var s=function(t,a,n){if(t.__modal=!!n,t._is_creation)for(var r in e.query)r.match(/^_/)||t.hasOwnProperty(r)&&(t[r]=e.query[r]);return t._options=a,i(t)},d=function(e,t){ScaffoldActionsHelper.initActions(e,!1),ScaffoldFormHelper.initForm(e.find("form"),function(r,i){ScaffoldFormHelper.cleanOptions(n,a),r._message&&toastr.success(r._message),r.redirect?"reload"===r.redirect?t?(Utils.showPreloader(e.find(".modal-dialog")),$.when(ScaffoldsManager.getResourceItemData(n,a,!1),ScaffoldFormHelper.loadOptions(n,a)).done(function(t,n){t._options=n,t._is_creation=!a;var r=$("<div></div>").html(s(t,n,!0));d(e.find(".modal-dialog").html("").append(r.find(".modal-content")),!0)}).always(function(){Utils.hidePreloader(e.find(".modal-dialog"))})):page.reload():"back"===r.redirect?t?e.modal("hide"):page.back(r.redirect_fallback||i.attr("data-back-url")||CmfConfig.rootUrl):(Utils.hidePreloader(i),page.show(r.redirect,null,!0,!0,{env:{is_ajax_response:!0,is_modal:t}})):t?e.modal("hide"):page.back(i.attr("data-back-url")),t&&ScaffoldDataGridHelper.reloadCurrentDataGrid()})};if(e.isSubRequest()||o.__modal&&!1!==e.env().is_modal&&(e.env().is_click||e.env().is_ajax_response)){var c=$("<div></div>").html(s(o,l,!0));if(!1!==c){var u=c.find(".modal");CmfRoutingHelpers.initModalAndContent(u,e).done(function(){d(u,!0),u.modal("show"),$(document.body).attr("data-modal-opened","1")})}CmfRoutingHelpers.hideContentContainerPreloader()}else CmfRoutingHelpers.setCurrentContent(s(o,l,!1),Utils.getContentContainer()).done(function(e){t(),d(e,!1)});CmfRoutingHelpers.routeHandled(e)})},CmfRouteChange.scaffoldItemClone=function(e){return e.env().is_clone=!0,CmfRouteChange.scaffoldItemFormPage(e)};var ScaffoldsManager={cacheTemplates:!0};ScaffoldsManager.getResourceBaseUrl=function(e,t){return CmfConfig.rootUrl+"/"+CmfConfig.scaffoldApiUrlSection+"/"+ScaffoldsManager.buildResourceUrlSuffix(e,t)},ScaffoldsManager.buildResourceUrlSuffix=function(e,t){return e+(t?"/"+t:"")},ScaffoldsManager.isValidResourceName=function(e){return"string"==typeof e&&String(e).match(/^[a-zA-Z_][a-zA-Z_0-9]+$/)},ScaffoldsManager.validateResourceName=function(e,t){if(!ScaffoldsManager.isValidResourceName(e))throw console.trace(),"Invalid REST resource name: "+e;if(void 0!==t&&"string"!=typeof t)throw console.trace(),"Additional parameter must be a string: "+typeof t+" received"},ScaffoldsManager.findResourceNameInUrl=function(e){var t=e.match(/\/resource\/([^\/]+)/i);return!!t&&t[0]},$.extend(CmfCache,{rawTemplates:{},compiledTemplates:{itemForm:{},bulkEditForm:{},itemDetails:{}},selectOptions:{},selectOptionsTs:{},itemDefaults:{}}),ScaffoldsManager.importTemplatesFromCmfSettings=function(e){if(e.hasOwnProperty("pages")&&$.isPlainObject(e.pages)&&$.extend(CmfCache.views,e.pages),e.hasOwnProperty("resources")&&$.isPlainObject(e.resources))for(var t in e.resources)$.isPlainObject(e.resources[t])&&(CmfCache.rawTemplates[t]=e.resources[t],CmfCache.rawTemplates[t].hasOwnProperty("itemFormDefaults")&&$.isPlainObject(CmfCache.rawTemplates[t].itemFormDefaults)&&(ScaffoldsManager.cacheDefaultItemData(t,CmfCache.rawTemplates[t].itemFormDefaults),delete CmfCache.rawTemplates[t].itemFormDefaults))},ScaffoldsManager.loadTemplates=function(e,t){ScaffoldsManager.validateResourceName(e,t);var a=$.Deferred();if(ScaffoldsManager.cacheTemplates&&ScaffoldsManager.isTemplatesLoaded(e,t))a.resolve(e,t);else{var n=ScaffoldsManager.getResourceBaseUrl(e,t);$.ajax({url:n+"/service/templates",method:"GET",cache:!1,type:"html"}).done(function(n){ScaffoldsManager.setResourceTemplates(e,t,n),a.resolve(e,t)}).fail(function(e){Utils.handleAjaxError.call(this,e,a)})}return a.promise()},ScaffoldsManager.setResourceTemplates=function(e,t,a){ScaffoldsManager.validateResourceName(e,t);var n=$('<div id="templates">'+a+"</div>"),r=ScaffoldsManager.buildResourceUrlSuffix(e,t);CmfCache.rawTemplates[r]={datagrid:!1,itemForm:!1,bulkEditForm:!1,itemDetails:!1};var i=n.find("#data-grid-tpl");i.length&&(CmfCache.rawTemplates[r].datagrid=i.html());var o=n.find("#item-form-tpl");o.length&&(CmfCache.rawTemplates[r].itemForm=o.html());var l=n.find("#bulk-edit-form-tpl");l.length&&(CmfCache.rawTemplates[r].bulkEditForm=l.html());var s=n.find("#item-details-tpl");s.length&&(CmfCache.rawTemplates[r].itemDetails=s.html())},ScaffoldsManager.isTemplatesLoaded=function(e,t){return!!CmfCache.rawTemplates[ScaffoldsManager.buildResourceUrlSuffix(e,t)]},ScaffoldsManager.hasDataGridTemplate=function(e,t){return ScaffoldsManager.validateResourceName(e,t),ScaffoldsManager.isTemplatesLoaded(e,t)&&CmfCache.rawTemplates[ScaffoldsManager.buildResourceUrlSuffix(e,t)].datagrid},ScaffoldsManager.hasItemFormTemplate=function(e,t){return ScaffoldsManager.validateResourceName(e,t),ScaffoldsManager.isTemplatesLoaded(e,t)&&CmfCache.rawTemplates[ScaffoldsManager.buildResourceUrlSuffix(e,t)].itemForm},ScaffoldsManager.hasBulkEditFormTemplate=function(e,t){return ScaffoldsManager.validateResourceName(e,t),ScaffoldsManager.isTemplatesLoaded(e,t)&&CmfCache.rawTemplates[ScaffoldsManager.buildResourceUrlSuffix(e,t)].bulkEditForm},ScaffoldsManager.hasItemDetailsTemplate=function(e,t){return ScaffoldsManager.validateResourceName(e,t),ScaffoldsManager.isTemplatesLoaded(e,t)&&CmfCache.rawTemplates[ScaffoldsManager.buildResourceUrlSuffix(e,t)].itemDetails},ScaffoldsManager.getDataGridTpl=function(e,t){ScaffoldsManager.validateResourceName(e,t);var a=$.Deferred();return ScaffoldsManager.loadTemplates(e,t).done(function(){if(!ScaffoldsManager.hasDataGridTemplate(e,t))throw"There is no data grid template for resource ["+e+"]"+(void 0===t?"":" with additional parameter ["+t+"]");a.resolve(CmfCache.rawTemplates[ScaffoldsManager.buildResourceUrlSuffix(e,t)].datagrid)}).fail(function(e){a.reject(e)}),a.promise()},ScaffoldsManager.getItemFormTpl=function(e,t){ScaffoldsManager.validateResourceName(e,t);var a=$.Deferred();return ScaffoldsManager.loadTemplates(e,t).done(function(){if(ScaffoldsManager.validateResourceName(e,t),!ScaffoldsManager.hasItemFormTemplate(e,t))throw"There is no item form template for resource ["+e+"]"+(void 0===t?"":" with additional parameter ["+t+"]");var n=ScaffoldsManager.buildResourceUrlSuffix(e,t);ScaffoldsManager.cacheTemplates&&CmfCache.compiledTemplates.itemForm[n]?a.resolve(CmfCache.compiledTemplates.itemForm[n]):Utils.makeTemplateFromText(CmfCache.rawTemplates[n].itemForm,"Item form template for "+n).done(function(e){CmfCache.compiledTemplates.itemForm[n]=e,a.resolve(e)}).fail(function(e){a.reject(e)})}).fail(function(e){a.reject(e)}),a.promise()},ScaffoldsManager.getBulkEditFormTpl=function(e,t){ScaffoldsManager.validateResourceName(e,t);var a=$.Deferred();return ScaffoldsManager.loadTemplates(e,t).done(function(){if(ScaffoldsManager.validateResourceName(e,t),!ScaffoldsManager.hasBulkEditFormTemplate(e,t))throw"There is no bulk edit form template for resource ["+e+"]"+(void 0===t?"":" with additional parameter ["+t+"]");var n=ScaffoldsManager.buildResourceUrlSuffix(e,t);ScaffoldsManager.cacheTemplates&&CmfCache.compiledTemplates.bulkEditForm[n]?a.resolve(CmfCache.compiledTemplates.bulkEditForm[n]):Utils.makeTemplateFromText(CmfCache.rawTemplates[n].bulkEditForm,"Bulk edit form template for "+n).done(function(e){CmfCache.compiledTemplates.bulkEditForm[n]=e,a.resolve(e)}).fail(function(e){a.reject(e)})}).fail(function(e){a.reject(e)}),a.promise()},ScaffoldsManager.getItemDetailsTpl=function(e,t){ScaffoldsManager.validateResourceName(e,t);var a=$.Deferred();return ScaffoldsManager.loadTemplates(e,t).done(function(){if(ScaffoldsManager.validateResourceName(e,t),!ScaffoldsManager.hasItemDetailsTemplate(e,t))throw"There is no item details template for resource ["+e+"]"+(void 0===t?"":" with additional parameter ["+t+"]");var n=ScaffoldsManager.buildResourceUrlSuffix(e,t);ScaffoldsManager.cacheTemplates&&CmfCache.compiledTemplates.itemDetails[n]?a.resolve(CmfCache.compiledTemplates.itemDetails[n]):Utils.makeTemplateFromText(CmfCache.rawTemplates[n].itemDetails,"Item details template for "+n).done(function(e){CmfCache.compiledTemplates.itemDetails[n]=e,a.resolve(e)}).fail(function(e){a.reject(e)})}).fail(function(e){a.reject(e)}),a.promise()},ScaffoldsManager.getResourceItemData=function(e,t,a){var n=$.Deferred();if(!t){if(a){var r="ScaffoldsManager.getDataForItem(): itemId argument is requred when argument forDetailsViewer == true";return console.error(r),n.reject(new Error(r)),n.promise()}if(CmfCache.itemDefaults[e])return n.resolve(CmfCache.itemDefaults[e]),n.promise();t="service/defaults"}return $.ajax({url:ScaffoldsManager.getResourceBaseUrl(e)+"/"+t+"?details="+(a?"1":"0"),method:"GET",cache:!1}).done(function(a){a.formUUID=Base64.encode(this.url+(new Date).getTime()),"service/defaults"===t&&ScaffoldsManager.cacheDefaultItemData(e,a),n.resolve(a)}).fail(function(e){Utils.handleAjaxError.call(this,e,n)}),n.promise()},ScaffoldsManager.cacheDefaultItemData=function(e,t){t.isCreation=!0,CmfCache.itemDefaults[e]=t};var ScaffoldActionsHelper={makeResourceBodyClass:function(e){return Utils.normalizeBodyClass("resource-"+e)},initActions:function(e,t){var a=$(e),n=function(){return ScaffoldActionsHelper.handleDataAction(this,a),!1};t?a.on("click tap","[data-action]",n):a.find("[data-action]").on("click tap",n)},beforeDataActionHandling:function(el,container){var callbackRet=null,callback=$(el).attr("data-before-action");return callback&&null!==callback.match(/^[a-zA-Z0-9_.$()\[\]]+$/)&&(eval("callback = "+callback),"function"==typeof callback&&(callbackRet=callback($(el)))),!1!==callbackRet},handleDataAction:function(e,t){if(!1!==ScaffoldActionsHelper.beforeDataActionHandling(e,t)){var a=$(e),n=$(t),r=String(a.attr("data-action")).toLowerCase(),i=n.hasClass("modal");switch(r){case"request":Utils.showPreloader(n),ScaffoldActionsHelper.handleRequestAction(a,ScaffoldActionsHelper.onSuccess,function(){ScaffoldActionsHelper.handleDataAction(e,t)}).done(function(){i&&("1"===a.attr("data-close-modal")&&n.modal("hide"),"1"===a.attr("data-reload-datagrid")&&ScaffoldDataGridHelper.reloadCurrentDataGrid())}).always(function(){Utils.hidePreloader(n)});break;case"redirect":i&&n.modal("hide"),page.show(a.attr("data-url"));break;case"reload":page.reload();break;case"back":if(i)n.modal("hide");else{var o=a.attr("data-url")||CmfConfig.rootUrl;page.back(o)}}}},handleRequestAction:function($el,onSuccess,onRepeat){var url=$el.attr("data-url")||$el.attr("href");if(!url||url.length<2)return $.Deferred().reject();if($el.attr("data-confirm")){var accepted=window.confirm($el.attr("data-confirm"));if(!accepted)return $.Deferred().reject()}var data=$el.attr("data-data")||$el.data("data")||"",method=String($el.attr("data-method")||"get").toLowerCase(),baseMethod;return $.inArray(method,["post","put","delete"])<0?baseMethod="GET":(baseMethod="POST","post"!==method&&($.isPlainObject(data)?data._method=method.toUpperCase():data+=(data.length?"&":"")+"_method="+method.toUpperCase())),"function"!=typeof onSuccess&&(onSuccess=function(){}),$.ajax({url:url,data:data,method:baseMethod,cache:!1,dataType:$el.attr("data-response-type")||"json"}).done(function(json){var ret=null,callback=$el.attr("data-on-success");onRepeat?"function"==typeof onRepeat&&(json.repeat_action=onRepeat):json.repeat_action=function(){ScaffoldActionsHelper.handleRequestAction($el,onSuccess)},callback&&null!==callback.match(/^[a-zA-Z0-9_.$()\[\]]+$/)&&(eval("callback = "+callback),"function"==typeof callback&&(ret=callback(json,$el,function(){return onSuccess(json)}))),!1!==ret&&onSuccess(json)}).fail(Utils.handleAjaxError)},onSuccess:Utils.handleAjaxSuccess},ScaffoldDataGridHelper={defaultConfig:{filter:!0,stateSave:!0,dom:"<'row'<'col-sm-12'<'#query-builder'>>><'row'<'col-xs-12 col-md-5'<'filter-toolbar btn-toolbar text-left'>><'col-xs-12 col-md-7'<'toolbar btn-toolbar text-right'>>><'row'<'col-sm-12'tr>><'row'<'col-sm-3 hidden-xs hidden-sm'i><'col-xs-12 col-md-6'p><'col-sm-3 hidden-xs hidden-sm'l>>",stateSaveCallback:function(e,t){var a=$.extend(!0,{},t);delete a.time;var n=this.api();if(void 0!==a.order&&$.isArray(a.order)){var r=a.order;delete a.order,a.sort={};for(var i=0;i<r.length;i++)a.sort[n.column(r[i][0]).dataSrc()]=r[i][1]}if(void 0!==a.search&&$.isPlainObject(a.search)&&void 0!==a.search.search){if(a.search.search.length>=2)try{a.filter=JSON.parse(a.search.search)}catch(e){console.warn("Failed to parse encoded filtering rules",a.search.search,e)}delete a.search}if(void 0!==a.columns&&$.isArray(a.columns)){var o=a.columns;delete a.columns,a.cv=[];for(var l=0;l<o.length;l++)a.cv.push(o[l].visible?1:0)}var s=JSON.stringify(a);if(e.iDraw>1){if(s!==e.initialState)if(page.currentRequest().env().is_history)page.currentRequest().customData.is_datagrid=!0,page.currentRequest().customData.api=n;else{var d=document.location.pathname+"?"+e.sTableId+"="+s+document.location.hash;page.show(d,null,!0,!0,{is_state_save:!0,is_datagrid:!0,api:n}),e.initialState=s}}else e.initialState=s,page.currentRequest().customData.is_datagrid=!0,page.currentRequest().customData.api=n},stateLoadCallback:function(e){var t=this.api(),a=new page.Request(document.location.pathname+document.location.search+document.location.hash);if(a.query[e.sTableId]){try{var n=JSON.parse(a.query[e.sTableId])}catch(t){CmfConfig.isDebug&&console.warn("Invalid JSON",a.query[e.sTableId],t)}try{if(n.time=(new Date).getTime(),void 0!==n.cv&&$.isArray(n.cv)){var r=n.cv;n.columns=[];for(var i=0;i<r.length;i++)n.columns.push({visible:!!r[i],search:{caseInsensitive:!0,regex:!1,search:"",smart:!0}});delete n.cv}if(void 0!==n.filter&&n.filter?(n.search={caseInsensitive:!0,regex:!1,search:n.filter?JSON.stringify(n.filter):"",smart:!0},delete n.filter):void 0!==n.search&&n.search||(n.search={caseInsensitive:!0,regex:!1,search:"",smart:!0}),void 0!==n.sort&&$.isPlainObject(n.sort)){n.order=[];var o=t.columns().dataSrc();for(var l in n.sort){var s=$.inArray(l,o);s>=0&&n.order.push([s,n.sort[l]])}delete n.sort}else void 0!==n.order&&n.order&&$.isArray(n.order)||(n.order=[]);return n}catch(e){CmfConfig.isDebug&&console.warn("Failed to parse DataTable state: ",n,e)}}else if(a.query.filter){var d=null;try{d=JSON.parse(a.query.filter)}catch(e){return CmfConfig.isDebug&&console.warn('Invalid json for "filter" query arg'),{}}try{if(d&&$.isPlainObject(d)){var c=$(e.nTable).data("configs"),u=null;$.isPlainObject(c)&&c.hasOwnProperty("queryBuilderConfig")&&$.isPlainObject(c.queryBuilderConfig)&&c.queryBuilderConfig.hasOwnProperty("fieldNameToFilterIdMap")&&(u=c.queryBuilderConfig.fieldNameToFilterIdMap);var f=DataGridSearchHelper.convertKeyValueFiltersToRules(d,u);if(f)return{time:(new Date).getTime(),search:{caseInsensitive:!0,regex:!1,search:f,smart:!0}}}return{}}catch(e){return CmfConfig.isDebug&&console.error('Failed to apply filters from "filter" query arg',e),{}}}return{}}},$currentDataGrid:null,setCurrentDataGrid:function(e){ScaffoldDataGridHelper.$currentDataGrid=e},getCurrentDataGrid:function(){return ScaffoldDataGridHelper.$currentDataGrid&&!document.contains(ScaffoldDataGridHelper.$currentDataGrid[0])&&(ScaffoldDataGridHelper.$currentDataGrid=null),ScaffoldDataGridHelper.$currentDataGrid},getCurrentDataGridApi:function(){return ScaffoldDataGridHelper.getCurrentDataGrid()?ScaffoldDataGridHelper.$currentDataGrid.dataTable().api():null},reloadCurrentDataGrid:function(){ScaffoldDataGridHelper.getCurrentDataGrid()&&ScaffoldDataGridHelper.getCurrentDataGridApi().ajax.reload(null,!1)},reloadStateOfCurrentDataGrid:function(e){if(ScaffoldDataGridHelper.getCurrentDataGrid()){var t=ScaffoldDataGridHelper.getCurrentDataGridApi();ScaffoldDataGridHelper.getCurrentDataGrid()._fnLoadState(t.settings()[0].oInit,function(){t.ajax.reload(null,!1),"function"==typeof e&&e()})}},init:function(e,t){var a=$(e);if(a.length){$.isPlainObject(t)||(t={});var n=a[0].outerHTML,r=$.extend(!0,{language:CmfConfig.getLocalizationStringsForComponent("data_tables")},ScaffoldDataGridHelper.defaultConfig,t);r.ajax&&(r.ajax={url:r.ajax,error:Utils.handleAjaxError});var i=$.extend(!0,{},r);return t.queryBuilderConfig&&(r.queryBuilderConfig=DataGridSearchHelper.prepareConfigs(t.queryBuilderConfig,t.defaultSearchRules)),a.data("configs",r).data("resourceName",r.resourceName).DataTable(r).on("init",function(e,a){var o=$(a.nTable),l=$(a.nTableWrapper);o.dataTable().api().settings()[0].resourceName=r.resourceName,ScaffoldDataGridHelper.initToolbar(l,t),r.queryBuilderConfig&&DataGridSearchHelper.init(o,r.queryBuilderConfig),ScaffoldDataGridHelper.initContextMenu(l,o,t),ScaffoldDataGridHelper.initClickEvents(l,o,t),ScaffoldDataGridHelper.initRowsRepositioning(o,l,t),ScaffoldDataGridHelper.initMultiselect(o,l,t),ScaffoldDataGridHelper.initBulkLinks(o,l,t),ScaffoldDataGridHelper.initBulkEditing(o,l,t),ScaffoldDataGridHelper.initNestedView(o,l,i,n)}).on("preXhr",function(e,t){CmfRoutingHelpers.cleanupHangedElementsInBody(),CmfRoutingHelpers.cleanupHangedElementsInContentWrapper(),$(this).dataTable().api().columns.adjust()}).on("draw",function(e,t){$(t.nTableWrapper).find('[data-toggle="tooltip"]').tooltip({container:Utils.getContentContainer()})}),a}throw"Invalid data grid id: "+a},initToolbar:function(e,t){var a=e.find(".toolbar"),n=e.find(".filter-toolbar"),r=$('<button class="btn btn-default" data-action="reload"></button>').html(CmfConfig.getLocalizationStringsForComponent("data_tables").toolbar.reloadData);if(n.length&&n.prepend(r),$.isArray(t.filterToolbarItems))for(var i=0;i<t.filterToolbarItems.length;i++)n.append(t.filterToolbarItems[i]);if(a.length&&(n.length||a.prepend(r),$.isArray(t.toolbarItems)))for(i=0;i<t.toolbarItems.length;i++)a.append(doT.template(t.toolbarItems[i])({}));if(t.stickyToolbar){a.closest(".toolbar-container").affix({offset:{top:function(){return this.top=$("header").filter(".main-header").outerHeight(!0)+$("#section-content").find("> .section-content-wrapper > .content-header").outerHeight(!0)},bottom:function(){return this.bottom=$("footer").filter(".main-footer").outerHeight(!0)}}})}},initContextMenu:function(e,t,a){if(a.contextMenuTpl){if("function"!=typeof a.contextMenuTpl){Utils.makeTemplateFromText(a.contextMenuTpl,"Data grid context menu template").done(function(e){a.contextMenuTpl=e}).fail(function(e){throw e})}var n=t.dataTable().api(),r=function(e,t,a,n){var r=$(window)[a](),i=$(window)[n](),o=e[a](),l=t+i;return t+o>r&&o<t&&(l-=o),l},i=null;t.on("contextmenu","td",function(o){if(!o.ctrlKey){i&&(i.trigger("hide.contextmenu"),i=null);var l=$(this).closest("tr"),s=n.row(l);return i=$(a.contextMenuTpl(s.data())),$(document.body).append(i),l.addClass("selected context-menu"),i.slideDown(80).css({position:"absolute",left:r(i,o.clientX,"width","scrollLeft"),top:r(i,o.clientY,"height","scrollTop")}).on("click","a",function(){if("request"===$(this).attr("data-action")){var t=$(this),a=function(t){var r=!!t.attr("data-block-datagrid");r&&Utils.showPreloader(e),ScaffoldActionsHelper.handleRequestAction(t,function(e){!e.redirect||"back"!==e.redirect&&"reload"!==e.redirect&&e.redirect!==document.location.path&&e.redirect!==document.location.pathname&&e.redirect!==document.location.href||(n.ajax.reload(null,!1),delete e.redirect),ScaffoldActionsHelper.onSuccess(e)},function(){a(t,r)}).always(function(){r&&Utils.hidePreloader(e)})};a(t)}i.trigger("hide.contextmenu"),i=null}).on("mousedown","a",function(e){return e.preventDefault(),!1}).on("hide.contextmenu",function(){var e=$(this);t.find("tr.selected.context-menu").removeClass("selected context-menu"),e.slideUp(80,function(){e.remove()})}),$("body").one("mousedown contextmenu keydown",function(){i&&!$.contains(i[0],this)&&(i.trigger("hide.contextmenu"),i=null)}),o.preventDefault(),!1}})}},initClickEvents:function(e,t,a){var n=t.dataTable().api();e.on("click tap","[data-action]",function(a){a.preventDefault();var r=$(this);if(r.hasClass("disabled"))return!1;if(!1===ScaffoldActionsHelper.beforeDataActionHandling(r,t))return!1;switch(String(r.attr("data-action")).toLowerCase()){case"reload":n.ajax.reload(null,!1);break;case"bulk-filtered":r.data("data",{conditions:n.search()}),r.attr("data-block-datagrid","1");case"bulk-selected":r.attr("data-block-datagrid","1");case"request":var i=function(t){var a=!!t.attr("data-block-datagrid");a&&Utils.showPreloader(e),ScaffoldActionsHelper.handleRequestAction(t,function(e){!e.redirect||"back"!==e.redirect&&"reload"!==e.redirect&&e.redirect!==document.location.path&&e.redirect!==document.location.pathname&&e.redirect!==document.location.href||(n.ajax.reload(null,!1),delete e.redirect),ScaffoldActionsHelper.onSuccess(e)},function(){i(t,a)}).always(function(){a&&Utils.hidePreloader(e)})};i(r)}return!1}),a&&a.doubleClickUrl&&t.on("dblclick dbltap","tbody tr",function(e){e.preventDefault();var t=e.target.tagName;if("I"!==t&&"SPAN"!==t||(t=$(e.target).parent()[0].tagName),!$(e.target).hasClass("select-checkbox")&&"A"!==t&&"BUTTON"!==t&&"INPUT"!==t){n.row($(this)).data()&&page.show(a.doubleClickUrl(n.row($(this)).data()),null,!0,!0,{env:{is_click:!0,target:e.target}})}return!1})},initRowsRepositioning:function(e,t,a){if(a.hasOwnProperty("rowsReordering")&&$.isPlainObject(a.rowsReordering)&&a.rowsReordering.hasOwnProperty("columns")&&a.rowsReordering.hasOwnProperty("url")){var n=e.dataTable().api(),r=function(){for(var e=n.order(),t=0;t<e.length;t++){var r=n.column(e[t][0]);if($.inArray(r.dataSrc(),a.rowsReordering.columns)>=0){r.nodes().to$().addClass("reorderable");break}}};r(),e.on("draw.dt",r);var i=doT.template(a.rowsReordering.url);new Sortable(e.find("tbody")[0],{group:e[0].id,sorting:!0,scroll:!0,handle:".reorderable",chosenClass:"reordering-this-element",onUpdate:function(e){for(var r="asc",o=null,l=n.order(),s=0;s<l.length;s++){var d=n.column(l[s][0]);if($.inArray(d.dataSrc(),a.rowsReordering.columns)>=0){o=d.dataSrc(),r=l[s][1];break}}if(null!==o){var c={moved_row:n.row(e.oldIndex).data(),before_or_after:e.oldIndex>e.newIndex?"before":"after",other_row:n.row(e.newIndex).data(),sort_column:o,sort_direction:r};Utils.showPreloader(t),$.ajax({url:i(c),method:"POST",data:{_method:"PUT"},type:"json"}).done(function(e){Utils.handleAjaxSuccess(e)}).fail(function(e){Utils.handleAjaxError.call(this,e)}).always(function(){Utils.hidePreloader(t),ScaffoldDataGridHelper.reloadCurrentDataGrid()})}}})}},initMultiselect:function(e,t,a){if(a&&a.multiselect){var n=e.dataTable().api();t.addClass("multiselect"),t.on("click","th .rows-selection-options ul a",function(){var e=$(this);if(e.hasClass("select-all"))n.rows().select();else if(e.hasClass("select-none"))n.rows().deselect();else if(e.hasClass("invert-selection")){var t=n.rows({selected:!0});n.rows({selected:!1}).select(),t.deselect()}})}},initBulkLinks:function(e,t,a){var n=t.find('[data-action="bulk-selected"], [data-action="bulk-edit-selected"], [data-type="bulk-selected"], [data-type="bulk-edit-selected"]'),r=t.find('[data-action="bulk-filtered"], [data-action="bulk-edit-filtered"], [data-type="bulk-filtered"], [data-type="bulk-edit-filtered"]');if(n.length||r.length){var i=e.dataTable().api();n.each(function(){$(this).data("label-tpl",$(this).html())}),r.each(function(){$(this).data("label-tpl",$(this).html())});var o=function(e,t){e.each(function(){var e=$(this);e.html(e.data("label-tpl").replace(/:count/g,String(t)));var a=e.parent("li");0===t?(e.addClass("disabled"),a.length&&a.addClass("disabled")):(e.removeClass("disabled"),a.length&&a.removeClass("disabled"))})};if(a&&a.multiselect&&n.length){var l=function(){var e=i.rows({selected:!0}),t=e.count()||0;o(n,t);var a=e.data();n.each(function(){var e=$(this).attr("data-id-field")||"id",t=[];a.each(function(a){t.push(a[e])}),$(this).data("data",{ids:t}),n.trigger("selectionchange.dt",i)})};l(),e.on("select.dt deselect.dt",function(e,t,a){"row"===a&&l()}),e.on("draw.dt",function(){l()}),n.on("click",function(){$(this).parent("li").parent("ul.dropdown-menu").length&&$(this).parent().parent().parent().find('[data-toggle="dropdown"]').dropdown("toggle")})}else n.addClass("disabled").parent("li").addClass("disabled");if(r.length){var s=function(){var e=0;if(i.search()){var t=DataGridSearchHelper.decodeRulesForDataTable(JSON.parse(i.search()),DataGridSearchHelper.getFieldNameToFilterIdMapForQueryBuilder());DataGridSearchHelper.countRules(t)>0&&(e=i.page.info().recordsTotal||0)}o(r,e)};s(),e.on("draw.dt",function(){s()}),r.on("click",function(){$(this).parent("li").parent("ul.dropdown-menu").length&&$(this).parent().parent().parent().find('[data-toggle="dropdown"]').dropdown("toggle")})}}},initBulkEditing:function(e,t,a){var n=t.find('[data-action="bulk-edit-selected"], [data-action="bulk-edit-filtered"]'),r=e.dataTable().api();n.on("click",function(){var e=$(this);return!e.hasClass("disabled")&&(ScaffoldFormHelper.handleBulkEditForm(e,a.resourceName,r),!1)})},initNestedView:function(e,t,a,n){if(a.nested_data_grid){var r=e.dataTable().api(),i=$.extend(!0,{},a,{dom:"<tr><'children-data-grid-pagination container-fluid'<'row'<'col-md-3 hidden-xs hidden-sm'i><'col-xs-12 col-md-9'p>>>",stateSave:!1,fixedHeader:{header:!1,footer:!1}});delete i.scrollY,delete i.scrollX,delete i.fixedColumns,t.on("click","a.show-children",function(){var e=$(this).closest("tr"),t=r.row(e);if($(this).addClass("hidden"),e.hasClass("has-children-table"))t.child.show();else{e.addClass("has-children-table");var a=t.data()[i.nested_data_grid.value_column],o=$(n);o.attr("id",o.attr("id")+"-children-for-"+a).attr("data-depth",(parseInt(e.closest(".children-data-grid").attr("data-depth"))||0)+1).addClass("table-condensed"),t.child(o).show();var l=$.extend(!0,{},i);l.ajax.url+="?parent="+a,o.DataTable(l).on("init",function(e,t){var a=$(t.nTable),r=$(t.nTableWrapper);return r.addClass("children-data-grid-table-container").parent().addClass("pn pb5 children-data-grid-cell").closest("tr").addClass("children-data-grid-row"),a.data("configs",l).addClass("children-data-grid-table"),ScaffoldDataGridHelper.initClickEvents(r,a,l),ScaffoldDataGridHelper.initNestedView(a,r,i,n),!1}).on("xhr",function(e,t,a){for(var n=o.attr("data-depth"),r=0,i=a.data.length;r<i;r++)a.data[r].___nesting_depth=n}).on("draw",function(e,t){var a=$(t.nTableWrapper);0===$(t.nTable).dataTable().api().page.info().recordsTotal?(a.find("thead").hide(),a.find(".children-data-grid-pagination").hide(),o.addClass("empty")):(a.find("thead").show(),a.find(".children-data-grid-pagination").show(),o.removeClass("empty"))})}e.addClass("children-table-opened").find("a.hide-children").removeClass("hidden")}).on("click","a.hide-children",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).closest("tr"),a=r.row(t);return $(this).tooltip("hide").addClass("hidden"),a.child.isShown()&&a.child.hide(),t.removeClass("children-table-opened").find("a.show-children").removeClass("hidden"),!1})}}},DataGridSearchHelper={id:"query-builder",containerId:"query-builder-container",defaultConfig:{plugins:["bt-tooltip-errors","bt-checkbox","bt-selectpicker","bt-selectpicker-values"],allow_empty:!0},locale:{submit:"Search",reset:"Reset",header:"Search rules"},emptyRules:{condition:"AND",rules:[]},getQueryBuilderNode:function(){return $("#"+DataGridSearchHelper.id)},getDataGridNodeForQueryBuilder:function(e){return(e||DataGridSearchHelper.getQueryBuilderNode()).data("dataGrid")},getDataGridApiForQueryBuilder:function(e){return(e||DataGridSearchHelper.getQueryBuilderNode()).data("dataGridApi")},getFieldNameToFilterIdMapForQueryBuilder:function(e){return(e||DataGridSearchHelper.getQueryBuilderNode()).data("config").fieldNameToFilterIdMap},prepareConfigs:function(e,t){if(e&&e.filters&&!(e.filters.length<=0)){for(var a in e.filters)"radio"!==e.filters[a].input&&"checkbox"!==e.filters[a].input||e.filters[a].color||(e.filters[a].color="primary");var n={rules:[]};return $.isArray(t)&&t.length?n={rules:t}:t.rules&&(n=$.extend({},t)),$.extend(n,DataGridSearchHelper.defaultConfig,e),n.fieldNameToFilterIdMap=DataGridSearchHelper.makeFieldNameToFilterIdMapFromFiltersConfig(n.filters),n}},init:function(e,t){if(t){var a=DataGridSearchHelper.getQueryBuilderNode();a.prepend("<h4>"+DataGridSearchHelper.locale.header+"</h4>");var n=$("<div></div>").attr("id",DataGridSearchHelper.id+"-content");a.append(n);var r=e.dataTable().api();if(e.data("queryBuilder",a),a.data("dataGrid",e),a.data("dataGridApi",r),n.queryBuilder(t),a.data("config",t),r.search().length)try{var i=JSON.parse(r.search()),o=DataGridSearchHelper.decodeRulesForDataTable(i,t.fieldNameToFilterIdMap);$.isPlainObject(o)&&$.isArray(o.rules)?n.queryBuilder("setRules",o):n.queryBuilder("setRules",t.rules)}catch(e){console.warn("invalid filter rules: "+r.search())}var l=$('<button class="btn btn-success" type="button"></button>').text(DataGridSearchHelper.locale.submit);l.on("click",function(){if(n.find(".rule-container").each(function(){var e=n.queryBuilder("getModel",$(this));e&&!e.filter&&e.drop()}),n.find(".rules-group-container").each(function(){var e=n.queryBuilder("getModel",$(this));if(e&&e.length()<=0&&!e.isRoot()){var t=e.parent;for(e.drop();t&&t.length()<=0&&!t.isRoot();){var a=t.parent;t.drop(),t=a}}}),n.queryBuilder("validate")){var e,a=n.queryBuilder("getRules");a.rules?n.queryBuilder("validate")&&(e=DataGridSearchHelper.encodeRulesForDataTable(a,t.fieldNameToFilterIdMap)):(n.queryBuilder("reset"),e=DataGridSearchHelper.encodeRulesForDataTable(DataGridSearchHelper.emptyRules,t.fieldNameToFilterIdMap)),r.search(e).draw()}});var s=$('<button class="btn btn-danger reset-filter" type="button"></button>').text(DataGridSearchHelper.locale.reset);s.hide().on("click",function(){n.queryBuilder("reset"),l.click(),s.hide()});var d=s.clone(!0).show(),c=a.closest(".dataTables_wrapper").find(".filter-toolbar");t.is_opened&&console.warn("Filter: is_opened option is not working currently and may never work in future");var u=$('<span class="counter label label-success ml10"></span>'),f=$('<button class="btn btn-default" type="button"></button>').text(DataGridSearchHelper.locale.toggle).append(u);a.addClass("collapse");var p=function(){var e=n.queryBuilder("getRules"),t=DataGridSearchHelper.countRules(e);t?(u.text(t).show(),s.show()):u.hide()};p();var m=function(e,t){if(e&&!n.queryBuilder("validate",{skip_empty:!0}))return!1;var a=$("#"+DataGridSearchHelper.id),r=DataGridSearchHelper.countRules(n.queryBuilder("getRules"));return e?(a.collapse("hide"),f.removeClass("active"),l.hide(),0===r&&s.hide()):(a.collapse("show"),f.addClass("active"),l.show(),r>0&&s.show()),!0};f.on("click",function(){m(f.hasClass("active"))}),c.append(f),l.on("click",function(){m(!0)&&p()}).hide()
;var h=$('<button type="button" class="btn btn-default btn-sm">').text(DataGridSearchHelper.locale.close).on("click",function(){m(!0)});a.append($('<div id="query-builder-controls">').append(h.addClass("pull-left")).append(l.addClass("btn-sm")).append(d.addClass("btn-sm"))),c.append(s)}},encodeRulesForDataTable:function(e,t,a){if(!$.isPlainObject(e))return{c:"AND",r:[]};var n={c:e.condition||"AND",r:[]};if($.isPlainObject(t)?$.isPlainObject(t.___unprefixedToPrefixedMap)||(t.___unprefixedToPrefixedMap={}):t={___unprefixedToPrefixedMap:{}},e.rules)for(var r=0;r<e.rules.length;r++){var i=e.rules[r];i.condition?n.r.push(DataGridSearchHelper.encodeRulesForDataTable(i,t,!0)):(t.___unprefixedToPrefixedMap.hasOwnProperty(i.field)&&(i.field=t.___unprefixedToPrefixedMap[i.field]),n.r.push({f:i.field,o:i.operator,v:DataGridSearchHelper.normalizeRuleValue(i.value)}))}return a?n:JSON.stringify(n)},makeFieldNameToFilterIdMapFromFiltersConfig:function(e){for(var t={___unprefixedToPrefixedMap:{}},a=0;a<e.length;a++){t[e[a].field]=e[a].id;var n=e[a].field.match(/\.([a-zA-Z_0-9-]+)$/);null===n||t.hasOwnProperty(n[1])||(t[n[1]]=e[a].id,t.___unprefixedToPrefixedMap[n[1]]=e[a].field)}return t},decodeRulesForDataTable:function(e,t){if(!e||!$.isArray(e.r))return null;for(var a={condition:e.c,rules:[]},n=0;n<e.r.length;n++){var r=e.r[n];if(r.c){var i=DataGridSearchHelper.decodeRulesForDataTable(r,t);null!==i&&a.rules.push(i)}else{if(!t[r.f])continue;a.rules.push({id:t[r.f],operator:r.o,value:DataGridSearchHelper.normalizeRuleValue(r.v)})}}return a},countRules:function(e){if(!e)return 0;e=DataGridSearchHelper.encodeRulesForDataTable(e,null,!0);for(var t=0,a=0;a<e.r.length;a++){var n=e.r[a];n.c?t+=DataGridSearchHelper.countRules(n):t++}return t},convertKeyValueFiltersToRules:function(e,t){var a=[];if(!e)return!1;for(var n in e)"string"==typeof n&&a.push({field:n,operator:"equal",value:DataGridSearchHelper.normalizeRuleValue(e[n])});return!!a.length&&DataGridSearchHelper.encodeRulesForDataTable({condition:"AND",rules:a},t)},normalizeRuleValue:function(e){return!0===e?"t":!1===e?"f":e}},ScaffoldFormHelper={loadOptions:function(e,t,a){var n=$.Deferred(),r=t?"?id="+t:"",i=e+(t?"":String(t));return a||!ScaffoldsManager.cacheTemplates||!CmfCache.selectOptions[i]||CmfCache.selectOptionsTs[i]+3e4<Date.now()?$.ajax({url:ScaffoldsManager.getResourceBaseUrl(e)+"/service/options"+r,method:"GET",cache:!1}).done(function(e){CmfCache.selectOptionsTs[i]=Date.now(),CmfCache.selectOptions[i]=e,n.resolve(CmfCache.selectOptions[i])}).fail(function(e){Utils.handleAjaxError.call(this,e,n)}):n.resolve(CmfCache.selectOptions[i]),n.promise()},cleanOptions:function(e,t){var a=e+(t?"":String(t));delete CmfCache.selectOptions[a],delete CmfCache.selectOptionsTs[a]},initForm:function(e,t){FormHelper.initForm(e,e,t)},handleBulkEditForm:function(e,t,a){try{var n=ScaffoldsManager.getBulkEditFormTpl(t)}catch(e){toastr.error(e)}$(".modal.in").modal("hide"),Utils.showPreloader(CmfRoutingHelpers.$currentContentContainer);var r=setTimeout(function(){CmfRoutingHelpers.hideContentContainerPreloader(),toastr.info("Server response timed out")},2e4);$.when(n,ScaffoldFormHelper.loadOptions(t,"bulk-edit")).done(function(t,n){var r={_options:n};if("bulk-edit-selected"===e.attr("data-action")){r._ids=[];var i=e.attr("data-id-field")||"id";if(a.rows({selected:!0}).data().each(function(e){r._ids.push(e[i])}),!r._ids)return toastr.error("No rows selected"),!1}else r._conditions=a.search();var o=$(t(r)),l=o.find("form");l.find("input, select, textarea").not('[type="hidden"]').not(".bulk-edit-form-input-enabler-switch, .bulk-edit-form-input-enabler-input").prop("disabled",!0).filter('[type="checkbox"]').not(".switch").closest(".bulk-edit-form-input-container").addClass("checkbox").end().end().filter(".switch").closest(".bulk-edit-form-input-container").addClass("checkbox-switch").end().end().end().filter('[type="radio"]').not(".switch").closest(".bulk-edit-form-input-container").addClass("radio").end().end().filter(".switch").closest(".bulk-edit-form-input-container").addClass("radio-switch").end().end(),l.find(".bulk-edit-form-input label").on("click",function(){$(this).closest(".bulk-edit-form-input-container").find(".bulk-edit-form-input-enabler-switch, .bulk-edit-form-input-enabler-input").prop("checked",!0).change()});var s=function(){return l.find(".bulk-edit-form-input-enabler-switch:checked, .bulk-edit-form-input-enabler-input:checked").length>0},d=function(){var e=$(this).closest(".bulk-edit-form-input-container").find(".bulk-edit-form-input").find("input, textarea, select");e.prop("disabled",!this.checked),setTimeout(function(){e.not('[type="hidden"], .switch').focus()},50),e.filter(".switch").bootstrapSwitch("disabled",!this.checked),e.filter("select.selectpicker").selectpicker("refresh"),e.trigger("toggle.bulkEditEnabler",!this.checked),l.find('[type="submit"]').prop("disabled",!s())};l.find(".bulk-edit-form-input-enabler-switch").on("change switchChange.bootstrapSwitch",d).change(),l.find(".bulk-edit-form-input-enabler-input").on("change click",d).change(),$(document.body).append(o),o.on("hidden.bs.modal",function(){o.remove()}).on("show.bs.modal",function(){l.on("submit",function(){return s()}),ScaffoldFormHelper.initForm(l,function(e,t,n){e._message&&toastr.success(e._message),o.modal("hide");var r=!0,i=$(a.table().node()).data("configs").pkColumnName;if(i){var l=a.order();l.length&&a.column(l[0]).dataSrc()===i&&(r=!1)}a.rows().deselect(),a.ajax.reload(null,r)})}).on("shown.bs.modal",function(){$("body").addClass("modal-open")}).modal({backdrop:"static",keyboard:!1,show:!0})}).always(function(){clearTimeout(r),CmfRoutingHelpers.hideContentContainerPreloader()})},initWysiwyg:function(e,t){$.isPlainObject(t)||(t={}),void 0!==t.data_inserts&&$.isArray(t.data_inserts)&&(t=ScaffoldFormHelper.addDataInsertsPluginToWysiwyg(t)),void 0!==t.html_inserts&&$.isArray(t.html_inserts)&&(t=ScaffoldFormHelper.addHtmlInsertsPluginToWysiwyg(t)),$(e).ckeditor(t||{})},addDataInsertsPluginToWysiwyg:function(e){var t="span(wysiwyg-data-insert)[title];div(wysiwyg-data-insert)[title]",a="cmf_scaffold_data_inserter";if(e.extraAllowedContent?e.extraAllowedContent+=";"+t:e.extraAllowedContent=t,e.extraPlugins?e.extraPlugins+=","+a:e.extraPlugins=a,e.dialog_noConfirmCancel=!0,!CKEDITOR.plugins.get(a)){var n=CmfConfig.getLocalizationStringsForComponent("ckeditor"),r=function(e){var t=e.__tag||"div";return $("<insert></insert>").append($("<"+t+"></"+t+">").addClass("wysiwyg-data-insert").attr("title",(e.title||"").replace(/"/g,"'")).text(e.code||"")).html()};CKEDITOR.plugins.add(a,{requires:"widget",allowedContent:t,init:function(e){e.ui.addRichCombo("cmfScaffoldDataInserter",{label:n.cmf_scaffold_data_inserts_plugin_title,title:n.cmf_scaffold_data_inserts_plugin_title,toolbar:"insert",className:"cke_combo_full_width",multiSelect:!1,panel:{css:[CKEDITOR.skin.getPath("editor")].concat("body{font-family:Arial,sans-serif;font-size:14px;}"+(e.contentsCss||"")),multiSelect:!1},init:function(){for(var t=this,a=0;a<e.config.data_inserts.length;a++){var i,o=e.config.data_inserts[a];if(o.title=$.trim(o.title),o.args_options&&$.isPlainObject(o.args_options)){o.args_options.__tag={type:"select",label:n.cmf_scaffold_data_inserts_dialog_insert_tag_name,options:{span:n.cmf_scaffold_inserts_dialog_insert_tag_is_span,div:n.cmf_scaffold_inserts_dialog_insert_tag_is_div},value:"span"};var l=e.id+"_dialog_for_data_insert_"+a;if(!function(t,a){return ScaffoldFormHelper.makeWysiwygDialogForDataInserts(t.args_options,a,t.title,function(a,n){var i=$.extend({},t);i.__tag=a.__tag||"span",delete a.__tag;for(var o in a){var l;l=t.args_options[o].base64?Base64.encode(a[o]):a[o].replace(/(['"])/g,"\\$1"),i.code=i.code.replace(":"+o,l)}if(t.widget_title_tpl){i.title=i.widget_title_tpl;for(o in a)t.args_options[o]&&"select"===t.args_options[o].type?(i.title=i.title.replace(":"+o+".value",$.trim(a[o])),n[o]&&(i.title=i.title.replace(":"+o+".label",$.trim(n[o][a[o]])||""))):i.title=i.title.replace(":"+o,$.trim(a[o]))}if(i.title=$.trim(i.title),e.focus(),e.fire("saveSnapshot"),"div"===i.__tag){var s;s=e.getSelection().getRanges().length>0?e.getSelection().getRanges()[0].getCommonAncestor(!0,!0):e.createRange().root;var d=e.createRange();d.moveToPosition(s,CKEDITOR.POSITION_AFTER_END),e.getSelection().selectRanges([d]),e.insertHtml(r(i),"unfiltered_html");var c=$(s.$);c.filter("p").length&&""===$.trim(c.text().replace(/&nbsp;/gi,""))&&c.remove()}else e.insertHtml(r(i),"unfiltered_html");e.fire("saveSnapshot")})}(o,l))continue;i="dialog:"+l}else o.__tag=o.is_block?"div":"span",i="insert:"+a;t.add(i,o.title,o.title)}},onClick:function(t){var a=t.match(/^(dialog|insert):(.*)$/);if(null!==a)switch(a[1]){case"dialog":e.openDialog(a[2]);break;case"insert":var n=e.config.data_inserts[parseInt(a[2])];if(n){if(e.focus(),e.fire("saveSnapshot"),n.is_block){var i;i=e.getSelection().getRanges().length>0?e.getSelection().getRanges()[0].getCommonAncestor(!0,!0):e.createRange().root;var o=e.createRange();o.moveToPosition(i,CKEDITOR.POSITION_AFTER_END),e.getSelection().selectRanges([o]),e.insertHtml(r(n),"unfiltered_html");var l=$(i.$);l.filter("p").length&&""===$.trim(l.text().replace(/&nbsp;/gi,""))&&l.remove()}else e.insertHtml(r(n),"unfiltered_html");e.fire("saveSnapshot")}else console.error("Insert with index "+a[2]+" not found")}else e.focus(),e.fire("saveSnapshot"),e.insertHtml(t),e.fire("saveSnapshot")}}),e.widgets.add("CmfScaffoldInsertedData",{allowedContent:t,requiredContent:t,upcast:function(e){return("span"===e.name||"div"===e.name)&&e.hasClass("wysiwyg-data-insert")}})},onLoad:function(){CKEDITOR.addCss(".wysiwyg-data-insert{font-size:0}span.wysiwyg-data-insert{display:inline-block;}div.wysiwyg-data-insert{margin: 10px 0 10px 0}.wysiwyg-data-insert:before{content:attr(title);position:static;display:block;font-size:12px;padding:0 5px;background:#DDD;border-radius:2px;-moz-border-radius:2px;-webkit-border-radius:2px;border:1px solid #555;white-space:nowrap;cursor:pointer;text-align:center;}span.wysiwyg-data-insert:before{display: inline-block}")}})}return e},makeWysiwygDialogForDataInserts:function(e,t,a,n){var r=!0,i=0,o=[],l={};for(var s in e){var d=e[s];if(!d.label){console.error(a+': label is required for each selector config for input "'+s+'"'),r=!1;break}switch(d.type||(d.type=d.options?"select":"text"),d.type){case"select":d.options||(console.error(a+': options are required for input "'+s+'"'),r=!1);var c={type:"select",label:d.label,id:s,items:[],default:void 0!==d.value?d.value:null};if($.isPlainObject(d.options)){for(var u in d.options)c.items.push([d.options[u],u]);c.onLoad=function(){var e=this,t=$(e._.select.getElement().$);l[e.id]={},t.find("option").each(function(){l[e.id][this.value]=$(this).text()})}}else!function(e,t){c.onLoad=function(){var t=this,a=t._.dialog._.editor.element.$.form,n=$(a).attr("data-id-field"),r={};n&&a[n]&&a[n].value&&(r.pk=a[n].value),$.ajax({url:e.options,method:"GET",data:r,dataType:"json",cache:!1}).done(function(e){var a=$(t._.select.getElement().$);for(var n in e)if($.isPlainObject(e[n])){var r=$("<optgroup>").attr("label",n);a.append(r);for(var i in e[n])t.default||(t.default=i),r.append($("<option>").attr("value",i).html(e[n][i]))}else t.default||(t.default=n),t.add(e[n],n);l[t.id]={},a.find("option").each(function(){l[t.id][this.value]=$(this).text()})}).fail(Utils.handleAjaxError)},c.onShow=function(){var t=$(this.getInputElement().$);t.val(void 0===e.value?t.find("option").first().attr("value"):e.value)}}(d);o.push(c);break;case"checkbox":o.push({type:"checkbox",label:d.label,id:s,default:!!d.checked});break;case"textarea":o.push({type:"textarea",label:d.label,id:s,default:void 0!==d.value?d.value:""});break;default:o.push({type:"text",label:d.label,id:s,default:void 0!==d.value?d.value:""})}i++}return!!r&&(CKEDITOR.dialog.exists(t)||CKEDITOR.dialog.add(t,function(){return{title:a,minWidth:400,minHeight:40*i,contents:[{id:"tab1",label:"-",title:"-",expand:!0,padding:0,elements:o}],buttons:[CKEDITOR.dialog.okButton,CKEDITOR.dialog.cancelButton],onOk:function(){var t={};for(var a in e){var r=this.getContentElement("tab1",a);t[a]=r?this.getContentElement("tab1",a).getValue():""}"function"==typeof n&&n.call(this,t,l)}}}),!0)},addHtmlInsertsPluginToWysiwyg:function(e){var t="cmf_scaffold_html_inserter";if(e.extraPlugins?e.extraPlugins+=","+t:e.extraPlugins=t,!CKEDITOR.plugins.get(t)){var a=CmfConfig.getLocalizationStringsForComponent("ckeditor"),n=function(e){return $("<insert></insert>").append(e.html).html()};CKEDITOR.plugins.add(t,{allowedContent:"*[!class]; *[!id]; a[!href]",disallowedContent:"script style",init:function(e){e.ui.addRichCombo("cmfScaffoldHtmlInserter",{label:a.cmf_scaffold_html_inserts_plugin_title,title:a.cmf_scaffold_html_inserts_plugin_title,toolbar:"insert",className:"cke_combo_full_width",multiSelect:!1,panel:{css:[CKEDITOR.skin.getPath("editor")].concat("body{font-family:Arial,sans-serif;font-size:14px;}"+(e.contentsCss||"")),multiSelect:!1},init:function(){for(var t=this,a=0;a<e.config.html_inserts.length;a++){var n,r=e.config.html_inserts[a];r.title=$.trim(r.title),n="html:"+a,t.add(n,r.title,r.title)}},onClick:function(t){var a=t.match(/^(html):(.*)$/);if(null!==a)switch(a[1]){case"html":var r=e.config.html_inserts[parseInt(a[2])];if(r){if(e.focus(),e.fire("saveSnapshot"),r.is_block){var i;i=e.getSelection().getRanges().length>0?e.getSelection().getRanges()[0].getCommonAncestor(!0,!0):e.createRange().root;var o=e.createRange();o.moveToPosition(i,CKEDITOR.POSITION_AFTER_END),e.getSelection().selectRanges([o]),e.insertHtml(n(r),"unfiltered_html");var l=$(i.$);l.filter("p").length&&""===$.trim(l.text().replace(/&nbsp;/gi,""))&&l.remove()}else e.insertHtml(n(r),"unfiltered_html");e.fire("saveSnapshot")}else console.error("HTML Insert with index "+a[2]+" not found")}else e.focus(),e.fire("saveSnapshot"),e.insertHtml(t),e.fire("saveSnapshot")}})}})}return e}},CmfFileUploads={baseUploaderOptions:{language:$(document.body).attr("data-locale"),validateInitialCount:!0,showUpload:!1,allowedFileTypes:["image","text","video","audio","object"],allowedPreviewTypes:["image","video","audio"],previewFileType:"any",previewFileIcon:'<i class="fa fa-file"></i>',initialPreviewAsData:!0,overwriteInitial:!0,fileActionSettings:{showDrag:!1,showDownload:!0},browseIcon:'<i class="glyphicon glyphicon-picture"></i>',layoutTemplates:{main1:"{preview}\n<div class='input-group {class}'>\n   <div class='input-group-btn'>\n       {browse}\n       {upload}\n       {remove}\n   </div>\n   {caption}\n</div>"}},imageUploaderOptions:{allowedFileTypes:["image"],allowedPreviewTypes:["image"],previewFileType:"image",initialPreviewFileType:"image"},fileUploaderOptions:{fileActionSettings:{showDrag:!1,showDownload:!0,showBrowse:!1},initialPreviewFileType:"object",previewFileIconSettings:{doc:'<i class="fa fa-file-word-o text-primary"></i>',docx:'<i class="fa fa-file-word-o text-primary"></i>',txt:'<i class="fa fa-file-text-o"></i>',json:'<i class="fa fa-file-text-o"></i>',js:'<i class="fa fa-file-text-o"></i>',rtf:'<i class="fa fa-file-text-o"></i>',xls:'<i class="fa fa-file-excel-o text-success"></i>',xlsx:'<i class="fa fa-file-excel-o text-success"></i>',csv:'<i class="fa fa-file-excel-o text-success"></i>',ppt:'<i class="fa fa-file-powerpoint-o text-danger"></i>',pptx:'<i class="fa fa-file-powerpoint-o text-danger"></i>',pdf:'<i class="fa fa-file-pdf-o text-danger"></i>',zip:'<i class="fa fa-file-archive-o text-muted"></i>',gzip:'<i class="fa fa-file-archive-o text-muted"></i>',rar:'<i class="fa fa-file-archive-o text-muted"></i>'}}};CmfFileUploads.initFileUploaders=function(e,t,a){for(var n in e.configs)CmfFileUploads.initFileUploader(e,n,t,a)},CmfFileUploads.initFileUploader=function(e,t,a,n){var r=e.configs[t],i=1===r.max_files_count;r.defaultPluginOptions=$.extend({layoutTemplates:{}},CmfFileUploads.baseUploaderOptions,a?CmfFileUploads.imageUploaderOptions:CmfFileUploads.fileUploaderOptions,$.isPlainObject(n)?n:{},{allowedFileExtensions:r.allowed_extensions,minFileCount:0,maxFileCount:1,maxFileSize:r.max_file_size,showCaption:i,previewClass:i?"single-file-upload":"multi-file-upload"}),i||(r.defaultPluginOptions.layoutTemplates.main2='<button class="fileinput-dragger" type="button"><span class="fa fa-arrows"></span></button>{preview}\n<div class="kv-upload-progress kv-hidden"></div>\n<div class="clearfix"></div>\n<div class="kv-upload-toolbar text-center">{remove}\n{cancel}\n{upload}\n{browse}\n</div>',r.defaultPluginOptions.layoutTemplates.preview='<div class="file-preview {class}">\n    {close}    <div class="no-file">'+CmfConfig.getLocalizationStringsForComponent("file_uploader").no_file+'</div>    <div class="{dropClass}">\n    <div class="file-preview-thumbnails">\n    </div>\n    <div class="clearfix"></div>    <div class="file-preview-status text-center text-success"></div>\n    <div class="kv-fileinput-error"></div>\n    </div>\n</div>'),r.inputsAdded=0,r.isCloning=!!e.is_cloning,r.isInModal=!!e.is_in_modal,Utils.makeTemplateFromText($("#"+r.id+"-tpl").html(),"CmfFileUploads.initFileUploader for files group "+t).done(function(a){if(r.inputTpl=a,r.addInput=function(e,t){return CmfFileUploads.initFileUploaderInput(r,e,t)},$("#"+r.id+"-add").on("click",function(){return r.addInput(),r.inputsAdded>=r.max_files_count&&$(this).remove(),!1}),e.files&&$.isPlainObject(e.files)&&e.files.urls&&e.files.urls[t]&&e.files.preview_info&&e.files.preview_info[t]&&e.files.files&&e.files.files[t]){var n=e.files.urls[t],o=e.files.preview_info[t],l=e.files.files[t];if($.isArray(n)&&$.isArray(o)&&$.isArray(l))for(var s=0;s<n.length;s++)r.addInput({initialPreview:[n[s]],initialPreviewConfig:[o[s]],initialCaption:[o[s].caption]},$.extend({is_cloning:r.isCloning},l[s]))}0===r.inputsAdded&&(i||r.min_files_count>0)&&r.addInput();for(var d=r.inputsAdded;d<r.min_files_count;d++)r.addInput();if(!i){var c=$("#"+r.id+"-container");c.data("sortable",Sortable.create(c[0],{handle:".fileinput-dragger",draggable:".file-upload-input-container",animation:200,forceFallback:!0,onUpdate:function(e){$(e.to).find(".file-upload-input-container").each(function(e,t){$(t).find('input[name$="][position]"]').val(String(e+1)),$(t).find("input[name]").each(function(t,a){a.name=String(a.name).replace(/\]\[[0-9]\]\[/,"]["+String(e)+"][")})})}}))}})},CmfFileUploads.initFileUploaderInput=function(e,t,a){if(e.inputsAdded>=e.max_files_count)return!1;$.isPlainObject(a)||(a={}),a=$.extend({index:e.inputsAdded},a);var n=$(e.inputTpl(a));$("#"+e.id+"-container").append(n),e.inputsAdded++;var r=n.find('input[type="file"]'),i=$.extend({},e.defaultPluginOptions,$.isPlainObject(t)?t:{});if(a.is_cloning&&a.url){var o=new XMLHttpRequest;o.onload=function(){var e=new FileReader;e.onloadend=function(){$("#"+r[0].id+"-file-data").val(JSON.stringify($.extend({data:e.result},a)))},e.readAsDataURL(o.response)},o.open("GET",a.url),o.responseType="blob",o.send()}r.fileinput(i).on("fileclear",function(){$("#"+this.id+"-deleted").val("1"),$("#"+this.id+"-file-data").remove();var t=$("#"+e.id+"-container").data("sortable");if(t){var a=t.toArray(),n=$.inArray(this.id,a);n>=0&&(a.splice(n,1),a.push(this.id),t.sort(a))}}).on("change",function(){$("#"+this.id+"-file-data").remove()}).on("filezoomhidden",function(t,a){a.modal.remove(),e.isInModal&&($("body").addClass("modal-open"),$(".modal.in").css("padding-left","17px"))})};
